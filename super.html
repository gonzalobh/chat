<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Superadministrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900">
    <div class="max-w-4xl mx-auto py-16 px-4" id="app">
      <div id="loader" class="flex flex-col items-center gap-4">
        <div class="h-10 w-10 border-4 border-slate-300 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="text-slate-500 text-sm">Cargando...</p>
      </div>

      <div id="login" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow p-8 text-center space-y-6">
        <div>
          <h1 class="text-2xl font-semibold mb-2">Acceso Superadministrador</h1>
          <p class="text-sm text-slate-500">
            Inicia sesi√≥n con tu cuenta de Google autorizada para administrar empresas.
          </p>
        </div>
        <button
          id="google-login"
          class="flex w-full items-center justify-center gap-3 rounded-lg bg-blue-600 py-2 text-white font-medium hover:bg-blue-700 transition"
        >
          <span class="text-lg">üîê</span>
          Acceder con Google
        </button>
        <p id="login-error" class="mt-2 text-sm text-red-500 text-center hidden"></p>
      </div>

      <div id="unauthorized" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow p-8 text-center space-y-4">
        <h2 class="text-2xl font-semibold">Acceso denegado</h2>
        <p id="unauthorized-message" class="text-sm text-slate-500">
          Tu cuenta no tiene permisos para acceder a este panel.
        </p>
        <button
          id="unauthorized-logout"
          class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 transition"
        >
          Cerrar sesi√≥n
        </button>
      </div>

      <div id="dashboard" class="hidden space-y-8">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-semibold">Panel de empresas</h1>
            <p class="text-sm text-slate-500">Gestiona empresas y administradores globales.</p>
          </div>
          <button
            id="logout-btn"
            class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200"
          >
            Cerrar sesi√≥n
          </button>
        </div>

        <section class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-xl font-semibold mb-4">Crear empresa</h2>
          <form id="create-form" class="grid gap-4 md:grid-cols-3">
            <div class="md:col-span-1">
              <label for="company-name" class="block text-sm font-medium text-slate-600">Nombre de la empresa</label>
              <input
                id="company-name"
                type="text"
                placeholder="Boletum"
                class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div class="md:col-span-1">
              <label for="admin-email" class="block text-sm font-medium text-slate-600">Correo del administrador</label>
              <input
                id="admin-email"
                type="email"
                placeholder="admin@empresa.com"
                class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                required
              />
            </div>
            <div class="md:col-span-1 flex items-end">
              <button
                type="submit"
                class="w-full rounded-lg bg-blue-600 text-white py-2 font-medium hover:bg-blue-700 transition"
              >
                Crear empresa
              </button>
            </div>
          </form>
          <p id="create-message" class="mt-3 text-sm hidden"></p>
        </section>

        <section id="bot-ranking-card" class="bg-white rounded-2xl shadow p-6 space-y-5">
          <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
            <div>
              <h2 class="text-xl font-semibold">Ranking de bots por mensajes</h2>
              <p class="text-sm text-slate-500">
                Consulta los 5 bots con m√°s mensajes enviados en el periodo seleccionado.
              </p>
            </div>
            <div class="flex flex-wrap items-end gap-3">
              <div>
                <label for="bot-ranking-filter" class="block text-xs font-medium uppercase tracking-wide text-slate-500">
                  Periodo
                </label>
                <select
                  id="bot-ranking-filter"
                  class="mt-1 w-40 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="day">D√≠a</option>
                  <option value="month" selected>Mes</option>
                  <option value="year">A√±o</option>
                </select>
              </div>
              <div id="bot-ranking-day-wrapper" class="hidden">
                <label for="bot-ranking-day" class="block text-xs font-medium uppercase tracking-wide text-slate-500">
                  Fecha
                </label>
                <input
                  type="date"
                  id="bot-ranking-day"
                  class="mt-1 w-44 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div id="bot-ranking-month-wrapper" class="hidden">
                <label for="bot-ranking-month" class="block text-xs font-medium uppercase tracking-wide text-slate-500">
                  Mes
                </label>
                <input
                  type="month"
                  id="bot-ranking-month"
                  class="mt-1 w-44 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div id="bot-ranking-year-wrapper" class="hidden">
                <label for="bot-ranking-year" class="block text-xs font-medium uppercase tracking-wide text-slate-500">
                  A√±o
                </label>
                <input
                  type="number"
                  min="2000"
                  max="2100"
                  step="1"
                  id="bot-ranking-year"
                  class="mt-1 w-28 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>
          </div>

          <div id="bot-ranking-loader" class="flex items-center gap-3 text-sm text-slate-500">
            <div class="h-5 w-5 border-2 border-slate-200 border-t-blue-500 rounded-full animate-spin"></div>
            Cargando ranking...
          </div>

          <p id="bot-ranking-empty" class="text-sm text-slate-500 hidden"></p>

          <ol id="bot-ranking-list" class="space-y-3 hidden"></ol>
        </section>

        <section class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Empresas registradas</h2>
            <span id="company-count" class="text-sm text-slate-500"></span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-50 text-left text-xs font-medium uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-4 py-3">Nombre</th>
                  <th class="px-4 py-3">Email administrador</th>
                  <th class="px-4 py-3">Acciones</th>
                </tr>
              </thead>
              <tbody id="company-list" class="divide-y divide-slate-200 text-sm"></tbody>
            </table>
          </div>
          <p id="companies-empty" class="text-center text-sm text-slate-500 py-6 hidden">No hay empresas registradas.</p>
        </section>
      </div>
    </div>

    <div
      id="edit-modal"
      class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-900/60 p-4"
    >
      <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-xl font-semibold">Editar empresa</h3>
            <p id="edit-company-name" class="text-sm text-slate-500"></p>
          </div>
          <button id="close-edit" class="text-slate-400 hover:text-slate-600">‚úï</button>
        </div>
        <form id="edit-form" class="mt-6 space-y-4">
          <div>
            <label for="edit-admin-email" class="block text-sm font-medium text-slate-600">Correo del administrador</label>
            <input
              type="email"
              id="edit-admin-email"
              class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div>
            <label for="edit-hotel-name" class="block text-sm font-medium text-slate-600">Nombre visible</label>
            <input
              type="text"
              id="edit-hotel-name"
              class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="flex gap-3">
            <button
              type="submit"
              class="flex-1 rounded-lg bg-blue-600 py-2 text-white font-medium hover:bg-blue-700 transition"
            >
              Guardar cambios
            </button>
            <button
              type="button"
              id="cancel-edit"
              class="flex-1 rounded-lg border border-slate-300 py-2 font-medium text-slate-600 hover:bg-slate-100"
            >
              Cancelar
            </button>
          </div>
        </form>
        <p id="edit-message" class="mt-3 text-sm hidden"></p>
      </div>
    </div>

    <script>
const firebaseConfig = {
  apiKey: "AIzaSyC2c3S_NtouIjHPrk5LM5c0DQoTWyBrzH4",
  authDomain: "timbre-c9547.firebaseapp.com",
  databaseURL: "https://timbre-c9547-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "timbre-c9547",
  storageBucket: "timbre-c9547.firebasestorage.app",
  messagingSenderId: "127064655657",
  appId: "1:127064655657:web:a4e99dcbc6ab33f32c1938"
};


      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      const loader = document.getElementById("loader");
      const loginCard = document.getElementById("login");
      const loginButton = document.getElementById("google-login");
      const loginError = document.getElementById("login-error");
      const unauthorizedCard = document.getElementById("unauthorized");
      const unauthorizedMessage = document.getElementById("unauthorized-message");
      const unauthorizedLogoutBtn = document.getElementById("unauthorized-logout");
      const dashboard = document.getElementById("dashboard");
      const createForm = document.getElementById("create-form");
      const createMessage = document.getElementById("create-message");
      const companyList = document.getElementById("company-list");
      const companiesEmpty = document.getElementById("companies-empty");
      const companyCount = document.getElementById("company-count");
      const logoutBtn = document.getElementById("logout-btn");

      const rankingCard = document.getElementById("bot-ranking-card");
      const rankingFilter = document.getElementById("bot-ranking-filter");
      const rankingDayWrapper = document.getElementById("bot-ranking-day-wrapper");
      const rankingMonthWrapper = document.getElementById("bot-ranking-month-wrapper");
      const rankingYearWrapper = document.getElementById("bot-ranking-year-wrapper");
      const rankingDayInput = document.getElementById("bot-ranking-day");
      const rankingMonthInput = document.getElementById("bot-ranking-month");
      const rankingYearInput = document.getElementById("bot-ranking-year");
      const rankingList = document.getElementById("bot-ranking-list");
      const rankingEmpty = document.getElementById("bot-ranking-empty");
      const rankingLoader = document.getElementById("bot-ranking-loader");

      const editModal = document.getElementById("edit-modal");
      const editForm = document.getElementById("edit-form");
      const editAdminEmail = document.getElementById("edit-admin-email");
      const editHotelName = document.getElementById("edit-hotel-name");
      const editMessage = document.getElementById("edit-message");
      const editCompanyNameLabel = document.getElementById("edit-company-name");
      const closeEditBtn = document.getElementById("close-edit");
      const cancelEditBtn = document.getElementById("cancel-edit");

      let companiesRef = null;
      let currentEditCompany = null;

      let botRankingRef = null;
      let botRankingData = null;
      let botRankingLoaded = false;

      const invalidKeyChars = /[.#$\[\]]/;

      const DAY_IN_MS = 24 * 60 * 60 * 1000;

      const setRankingMessage = (message) => {
        if (!rankingEmpty) return;
        if (message) {
          rankingEmpty.textContent = message;
          rankingEmpty.classList.remove("hidden");
        } else {
          rankingEmpty.textContent = "";
          rankingEmpty.classList.add("hidden");
        }
      };

      const setRankingLoading = (loading) => {
        if (!rankingLoader) return;
        rankingLoader.classList.toggle("hidden", !loading);
        if (loading) {
          if (rankingList) rankingList.classList.add("hidden");
          setRankingMessage("");
        }
      };

      const formatRankingNumber = (value) => {
        const numeric = Number(value) || 0;
        try {
          return new Intl.NumberFormat("es-ES").format(numeric);
        } catch (error) {
          return numeric.toString();
        }
      };

      const normalizeRankingTimestamp = (value) => {
        if (value === null || value === undefined) return null;
        if (typeof value === "number") {
          if (!Number.isFinite(value) || value <= 0) return null;
          return value < 1e12 ? value * 1000 : value;
        }
        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) return null;
          const numeric = Number(trimmed);
          if (Number.isFinite(numeric) && numeric > 0) {
            return numeric < 1e12 ? numeric * 1000 : numeric;
          }
          const parsed = Date.parse(trimmed);
          if (!Number.isNaN(parsed)) return parsed;
        }
        return null;
      };

      const extractRankingTimestamp = (source) => {
        if (!source || typeof source !== "object") return null;
        const candidates = [
          "timestamp",
          "time",
          "createdAt",
          "updatedAt",
          "date",
          "sentAt",
          "firstMessageAt",
        ];
        for (const key of candidates) {
          const normalized = normalizeRankingTimestamp(source[key]);
          if (normalized) return normalized;
        }
        return null;
      };

      const countMessagesInRange = (botNode, start, end) => {
        if (!botNode || typeof botNode !== "object") return 0;
        const conversations = botNode.conversaciones || botNode.conversations || {};
        let total = 0;
        Object.values(conversations || {}).forEach((conversation) => {
          if (!conversation || typeof conversation !== "object") return;
          const rawCollection = conversation.mensajes || conversation.messages || {};
          const messages = Array.isArray(rawCollection)
            ? rawCollection
            : Object.values(rawCollection || {});
          if (messages.length) {
            messages.forEach((message) => {
              const ts = extractRankingTimestamp(message);
              if (ts && ts >= start && ts < end) {
                total += 1;
              }
            });
          } else {
            const fallbackTs = extractRankingTimestamp(conversation);
            if (fallbackTs && fallbackTs >= start && fallbackTs < end) {
              total += 1;
            }
          }
        });
        return total;
      };

      const getBotDisplayName = (botId, botNode, configNode) => {
        const label =
          botNode?.config?.hotelName ||
          botNode?.name ||
          configNode?.config?.hotelName ||
          configNode?.name ||
          botId;
        return label ? label.toString() : botId;
      };

      const getRankingRange = () => {
        if (!rankingFilter) return null;
        const mode = rankingFilter.value;
        if (mode === "day") {
          const value = rankingDayInput?.value;
          if (!value) return null;
          const start = new Date(`${value}T00:00:00`).getTime();
          if (!Number.isFinite(start)) return null;
          return { start, end: start + DAY_IN_MS };
        }
        if (mode === "month") {
          const value = rankingMonthInput?.value;
          if (!value) return null;
          const [yearStr, monthStr] = value.split("-");
          const year = Number(yearStr);
          const month = Number(monthStr);
          if (!Number.isFinite(year) || !Number.isFinite(month)) return null;
          const start = new Date(year, month - 1, 1).getTime();
          const end = new Date(year, month, 1).getTime();
          if (!Number.isFinite(start) || !Number.isFinite(end)) return null;
          return { start, end };
        }
        if (mode === "year") {
          const rawYear = rankingYearInput?.value;
          const year = Number(rawYear);
          if (!Number.isFinite(year)) return null;
          const start = new Date(year, 0, 1).getTime();
          const end = new Date(year + 1, 0, 1).getTime();
          if (!Number.isFinite(start) || !Number.isFinite(end)) return null;
          return { start, end };
        }
        return null;
      };

      const updateRankingInputsVisibility = () => {
        if (!rankingFilter) return;
        const mode = rankingFilter.value;
        if (rankingDayWrapper)
          rankingDayWrapper.classList.toggle("hidden", mode !== "day");
        if (rankingMonthWrapper)
          rankingMonthWrapper.classList.toggle("hidden", mode !== "month");
        if (rankingYearWrapper)
          rankingYearWrapper.classList.toggle("hidden", mode !== "year");
      };

      const renderBotRanking = () => {
        if (!rankingCard || !botRankingLoaded) return;
        const range = getRankingRange();
        if (!range) {
          if (rankingList) rankingList.classList.add("hidden");
          setRankingMessage("Selecciona un periodo v√°lido para ver el ranking.");
          return;
        }
        if (!botRankingData || !Object.keys(botRankingData).length) {
          if (rankingList) rankingList.classList.add("hidden");
          setRankingMessage("No hay datos de bots disponibles.");
          return;
        }

        const entries = [];
        Object.entries(botRankingData || {}).forEach(([companyName, companyData]) => {
          if (!companyData || typeof companyData !== "object") return;
          const bots = companyData.bots || {};
          const configBots = companyData.config?.bots || {};
          const botIds = new Set([
            ...Object.keys(bots || {}),
            ...Object.keys(configBots || {}),
          ]);
          botIds.forEach((botId) => {
            const botNode = bots?.[botId];
            const configNode = configBots?.[botId];
            if (!botNode && !configNode) return;
            const count = countMessagesInRange(botNode, range.start, range.end);
            entries.push({
              company: companyName,
              botId,
              label: getBotDisplayName(botId, botNode, configNode),
              count,
            });
          });
        });

        if (!entries.length) {
          if (rankingList) rankingList.classList.add("hidden");
          setRankingMessage("No hay bots registrados en la base de datos.");
          return;
        }

        entries.sort((a, b) => {
          if (b.count !== a.count) return b.count - a.count;
          return a.label.localeCompare(b.label);
        });

        const topEntries = entries.slice(0, 5);
        if (rankingList) {
          rankingList.innerHTML = "";
          topEntries.forEach((entry, index) => {
            const item = document.createElement("li");
            item.className =
              "flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50/60 px-4 py-3";
            item.innerHTML = `
              <div class="flex items-center gap-3">
                <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-sm font-semibold text-blue-600">${
                  index + 1
                }</span>
                <div>
                  <p class="font-medium text-slate-700">${entry.label}</p>
                  <p class="text-xs text-slate-500">${entry.company} ¬∑ ${entry.botId}</p>
                </div>
              </div>
              <span class="text-sm font-semibold text-slate-700">${formatRankingNumber(
                entry.count
              )} mensajes</span>
            `;
            rankingList.appendChild(item);
          });
          rankingList.classList.remove("hidden");
        }

        const hasMessages = topEntries.some((entry) => entry.count > 0);
        setRankingMessage(
          hasMessages
            ? ""
            : "No se registraron mensajes en el periodo seleccionado."
        );
      };

      const detachBotRankingListener = () => {
        if (botRankingRef) {
          botRankingRef.off();
          botRankingRef = null;
        }
        botRankingData = null;
        botRankingLoaded = false;
        if (rankingList) {
          rankingList.innerHTML = "";
          rankingList.classList.add("hidden");
        }
        setRankingMessage("");
        setRankingLoading(false);
      };

      const attachBotRankingListener = () => {
        if (!rankingCard) return;
        detachBotRankingListener();
        setRankingLoading(true);
        botRankingRef = db.ref("empresas");
        botRankingRef.on(
          "value",
          (snapshot) => {
            botRankingData = snapshot.val() || {};
            botRankingLoaded = true;
            setRankingLoading(false);
            renderBotRanking();
          },
          (error) => {
            console.error("No se pudo cargar el ranking de bots", error);
            botRankingData = {};
            botRankingLoaded = true;
            setRankingLoading(false);
            if (rankingList) rankingList.classList.add("hidden");
            setRankingMessage("No se pudo cargar el ranking de bots.");
          }
        );
      };

      if (rankingFilter) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        if (rankingDayInput && !rankingDayInput.value)
          rankingDayInput.value = `${year}-${month}-${day}`;
        if (rankingMonthInput && !rankingMonthInput.value)
          rankingMonthInput.value = `${year}-${month}`;
        if (rankingYearInput && !rankingYearInput.value)
          rankingYearInput.value = String(year);
        updateRankingInputsVisibility();
      }

      if (rankingFilter) {
        rankingFilter.addEventListener("change", () => {
          updateRankingInputsVisibility();
          renderBotRanking();
        });
      }

      [rankingDayInput, rankingMonthInput, rankingYearInput].forEach((input) => {
        if (!input) return;
        input.addEventListener("change", () => {
          renderBotRanking();
        });
        input.addEventListener("input", () => {
          renderBotRanking();
        });
      });

      const setVisible = (el, show) => {
        el.classList.toggle("hidden", !show);
        el.classList.toggle("flex", show && el.id === "edit-modal");
      };

      const showMessage = (el, message, type = "success") => {
        el.textContent = message;
        el.classList.remove("hidden", "text-red-500", "text-green-600");
        el.classList.add(type === "error" ? "text-red-500" : "text-green-600");
      };

      const hideMessage = (el) => {
        el.classList.add("hidden");
        el.textContent = "";
      };

      const resetCreateForm = () => {
        createForm.reset();
        hideMessage(createMessage);
      };

      const detachCompaniesListener = () => {
        if (companiesRef) {
          companiesRef.off();
          companiesRef = null;
        }
      };

      const renderCompanies = (snapshot) => {
        companyList.innerHTML = "";
        const companies = snapshot.val() || {};
        const names = Object.keys(companies);
        companyCount.textContent = names.length ? `${names.length} empresas` : "";

        if (!names.length) {
          companiesEmpty.classList.remove("hidden");
          return;
        }

        companiesEmpty.classList.add("hidden");
        names.sort((a, b) => a.localeCompare(b));
        names.forEach((name) => {
          const config = companies[name]?.config || {};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-slate-700">${name}</td>
            <td class="px-4 py-3 text-slate-600">${config.adminEmail || "-"}</td>
            <td class="px-4 py-3">
              <div class="flex gap-3">
                <button
                  class="text-blue-600 hover:underline"
                  data-action="edit"
                  data-company="${name}"
                >Editar</button>
                <button
                  class="text-red-600 hover:underline"
                  data-action="delete"
                  data-company="${name}"
                >Eliminar</button>
              </div>
            </td>`;
          companyList.appendChild(tr);
        });
      };

      const openEditModal = (companyName, data) => {
        currentEditCompany = companyName;
        editCompanyNameLabel.textContent = companyName;
        editAdminEmail.value = data?.config?.adminEmail || "";
        editHotelName.value = data?.config?.hotelName || companyName;
        hideMessage(editMessage);
        setVisible(editModal, true);
      };

      const closeEditModal = () => {
        currentEditCompany = null;
        editForm.reset();
        setVisible(editModal, false);
      };

      const provider = new firebase.auth.GoogleAuthProvider();

      loginButton.addEventListener("click", () => {
        hideMessage(loginError);
        auth.signInWithPopup(provider).catch((error) => {
          showMessage(loginError, error.message, "error");
        });
      });

      logoutBtn.addEventListener("click", () => {
        auth.signOut();
      });

      unauthorizedLogoutBtn.addEventListener("click", () => {
        auth.signOut();
      });

      createForm.addEventListener("submit", (event) => {
        event.preventDefault();
        hideMessage(createMessage);
        const companyRaw = document.getElementById("company-name").value.trim();
        const adminEmail = document.getElementById("admin-email").value.trim();

        if (!companyRaw) {
          showMessage(createMessage, "El nombre de la empresa es obligatorio.", "error");
          return;
        }

        if (invalidKeyChars.test(companyRaw)) {
          showMessage(
            createMessage,
            "El nombre no puede contener ., #, $, [, ]",
            "error"
          );
          return;
        }

        const companyKey = companyRaw;
        const updates = {};
        updates[`empresas/${companyKey}/config/adminEmail`] = adminEmail;
        updates[`empresas/${companyKey}/config/hotelName`] = companyRaw;
        updates[`empresas/${companyKey}/bots`] = {};

        db.ref()
          .update(updates)
          .then(() => {
            showMessage(createMessage, `Empresa ${companyKey} creada con √©xito.`);
            createForm.reset();
          })
          .catch((error) => {
            showMessage(createMessage, error.message, "error");
          });
      });

      companyList.addEventListener("click", (event) => {
        const action = event.target.dataset.action;
        const company = event.target.dataset.company;
        if (!action || !company) return;

        db.ref(`empresas/${company}`)
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();
            if (action === "edit") {
              openEditModal(company, data);
            } else if (action === "delete") {
              const confirmed = window.confirm(
                `¬øEliminar empresa ${company}? Esto no se puede deshacer.`
              );
              if (!confirmed) return;
              snapshot.ref
                .remove()
                .catch((error) => alert(`Error al eliminar: ${error.message}`));
            }
          });
      });

      editForm.addEventListener("submit", (event) => {
        event.preventDefault();
        if (!currentEditCompany) return;
        hideMessage(editMessage);

        const adminEmailUpdated = editAdminEmail.value.trim();
        const hotelNameUpdated = editHotelName.value.trim();

        if (!adminEmailUpdated || !hotelNameUpdated) {
          showMessage(editMessage, "Todos los campos son obligatorios.", "error");
          return;
        }

        const updates = {
          adminEmail: adminEmailUpdated,
          hotelName: hotelNameUpdated,
        };

        db.ref(`empresas/${currentEditCompany}/config`)
          .update(updates)
          .then(() => {
            showMessage(editMessage, "Cambios guardados correctamente.");
            setTimeout(closeEditModal, 1200);
          })
          .catch((error) => {
            showMessage(editMessage, error.message, "error");
          });
      });

      [closeEditBtn, cancelEditBtn].forEach((btn) =>
        btn.addEventListener("click", () => {
          closeEditModal();
        })
      );

      auth.onAuthStateChanged((user) => {
        hideMessage(loginError);
        if (!user) {
          detachCompaniesListener();
          detachBotRankingListener();
          setVisible(dashboard, false);
          setVisible(unauthorizedCard, false);
          setVisible(loginCard, true);
          setVisible(loader, false);
          return;
        }

        setVisible(loader, true);
        setVisible(loginCard, false);
        setVisible(unauthorizedCard, false);
        db.ref(`globalAdmins/${user.uid}`)
          .once("value")
          .then((snapshot) => {
            const isAdmin = snapshot.val() === true;
            if (isAdmin) {
              setVisible(loginCard, false);
              setVisible(loader, false);
              setVisible(dashboard, true);
              companiesRef = db.ref("empresas");
              companiesRef.on("value", renderCompanies);
              attachBotRankingListener();
            } else {
              detachCompaniesListener();
              detachBotRankingListener();
              unauthorizedMessage.textContent =
                "Tu cuenta no tiene permisos para acceder a este panel.";
              hideMessage(loginError);
              setVisible(loader, false);
              setVisible(dashboard, false);
              setVisible(unauthorizedCard, true);
            }
          })
          .catch((error) => {
            showMessage(loginError, error.message, "error");
            setVisible(loader, false);
            setVisible(dashboard, false);
            setVisible(unauthorizedCard, false);
            setVisible(loginCard, true);
            detachBotRankingListener();
          });
      });
    </script>
  </body>
</html>
