<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tomos · Admin</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

  <!-- Cropper.js -->
  <link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Manrope', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f6f6f6',
              100: '#e7e7e7',
              200: '#cfcfcf',
              300: '#b0b0b0',
              400: '#7a7a7a',
              500: '#4a4a4a',
              600: '#2f2f2f',
              700: '#1f1f1f',
              800: '#141414',
              900: '#0b0b0b',
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Manrope:wght@400;600&display=swap" rel="stylesheet">

  <style type="text/tailwindcss">
    @layer base {
      :root { color-scheme: light; }
      body { @apply font-sans bg-zinc-100 text-zinc-900 antialiased; }
      body.login-view { @apply bg-zinc-50; }
      body.login-view main { @apply items-center; }
      textarea { @apply min-h-[320px]; }
      #embedScriptBox { @apply min-h-[40px]; }
    }

    @layer components {
      .card { @apply rounded-3xl border border-zinc-200/70 bg-white/90 backdrop-blur px-6 py-5 shadow-sm shadow-black/5; }
      .chip { @apply inline-flex items-center gap-2 rounded-full border border-zinc-200 bg-white px-4 py-2 text-sm font-medium text-zinc-500 transition-colors hover:border-zinc-300 hover:text-zinc-900; }
      .chip.active { @apply border-transparent bg-zinc-900 text-white shadow-sm; }
      .appearance-chip { @apply min-w-[96px] justify-center; }
      .sidebar-btn { @apply flex items-center gap-3 rounded-2xl px-3 py-2 text-sm font-medium text-zinc-500 transition-colors hover:bg-zinc-900/5; }
      .sidebar-btn.active { @apply bg-zinc-900 text-white shadow-sm; }
      .sidebar-btn svg { @apply h-5 w-5; }
      .widget-mockup { @apply flex h-16 w-16 items-center justify-center rounded-2xl bg-zinc-900 shadow-lg shadow-black/20; }
      .widget-icon-trigger { @apply flex h-12 w-12 items-center justify-center rounded-2xl border border-zinc-200 bg-white text-zinc-500 transition hover:border-zinc-400 hover:text-zinc-900; }
      .widget-icon-option { @apply flex items-center justify-center rounded-2xl border-2 border-transparent bg-zinc-100 p-4 transition hover:border-zinc-300 hover:bg-zinc-200/70; }
      .widget-icon-option.active { @apply border-zinc-900 bg-zinc-200/70 shadow-inner; }
      .avatar-option { @apply relative flex h-14 w-14 items-center justify-center rounded-full border-2 border-transparent bg-zinc-100 transition hover:border-zinc-300; }
      .avatar-option.active { @apply border-zinc-900 bg-zinc-200/60 shadow-sm; }
      .avatar-option img { @apply h-11 w-11 rounded-full object-cover; }
      #toast { @apply pointer-events-none rounded-full bg-emerald-600 px-4 py-2 text-sm text-white shadow-lg transition-opacity duration-300; }
    }
  </style>
  <style>
    .toggle {
      --toggle-height: 28px;
      --toggle-width: 52px;
      appearance: none;
      -webkit-appearance: none;
      position: relative;
      display: inline-flex;
      align-items: center;
      width: var(--toggle-width);
      height: var(--toggle-height);
      border-radius: 9999px;
      border: 1px solid #d4d4d8;
      background: #fff;
      cursor: pointer;
      transition: background-color .2s ease, border-color .2s ease;
    }
    .toggle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 4px;
      width: 22px;
      height: 22px;
      border-radius: 9999px;
      background: #0b0b0b;
      transform: translateY(-50%);
      transition: left .2s ease, background-color .2s ease;
    }
    .toggle:checked {
      background: #0b0b0b;
      border-color: #0b0b0b;
    }
    .toggle:checked::after {
      left: calc(100% - 26px);
      background: #fff;
    }
    aside {
      scrollbar-width: thin;
      scrollbar-color: #d4d4d8 transparent;
    }
    aside::-webkit-scrollbar { width: 6px; height: 6px; }
    aside::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 9999px; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Loader -->
  <div id="pageLoader" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white/95">
    <div class="h-12 w-12 animate-spin rounded-full border-4 border-zinc-300 border-t-zinc-900"></div>
    <p class="mt-4 text-sm text-zinc-500">Loading…</p>
  </div>

  <!-- Header -->
  <header class="fixed inset-x-0 top-0 z-50 border-b border-zinc-200 bg-white/90 backdrop-blur">
    <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="Tomos Logo" class="h-10 w-auto rounded-xl" />
        <div class="flex flex-col">
          <span class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Tomos Admin</span>
          <span id="empresaBadge" class="text-xs font-semibold text-zinc-900">—</span>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex flex-col items-end text-right">
          <span class="text-xs text-zinc-400">Signed in as</span>
          <span id="authEmail" class="text-sm font-medium text-zinc-700">—</span>
        </div>
        <button id="btnLogout" class="hidden rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">
          Cerrar sesión
        </button>
      </div>
    </div>
  </header>
  <div id="headerSpacer" class="h-16"></div>

  <main class="flex min-h-[calc(100vh-4rem)] flex-col md:flex-row">
    <!-- Sidebar -->
    <aside class="w-full border-b border-zinc-200 bg-white/70 backdrop-blur md:w-64 md:border-b-0 md:border-r">
      <nav class="flex gap-2 overflow-x-auto px-4 py-3 md:flex-col md:gap-1 md:py-6">
        <button class="sidebar-btn active" data-tab="apariencia">
          <i data-lucide="palette" class="shrink-0"></i>
          <span class="hidden md:inline">Appearance</span>
        </button>
        <button class="sidebar-btn" data-tab="settings">
          <i data-lucide="sliders" class="shrink-0"></i>
          <span class="hidden md:inline">Settings</span>
        </button>
        <button class="sidebar-btn" data-tab="knowledge">
          <i data-lucide="book-open" class="shrink-0"></i>
          <span class="hidden md:inline">Knowledge</span>
        </button>
        <button class="sidebar-btn" data-tab="integration">
          <i data-lucide="code-2" class="shrink-0"></i>
          <span class="hidden md:inline">Integration</span>
        </button>
        <button class="sidebar-btn" data-tab="respuestas">
          <i data-lucide="bot" class="shrink-0"></i>
          <span class="hidden md:inline">Auto Responses</span>
        </button>
        <button class="sidebar-btn" data-tab="schedule">
          <i data-lucide="clock" class="shrink-0"></i>
          <span class="hidden md:inline">Schedule</span>
        </button>
      </nav>
      <div class="hidden px-4 pb-6 text-xs text-zinc-500 md:block">
        Empresa: <span id="empresaText" class="font-medium text-zinc-700">—</span>
      </div>
    </aside>

    <!-- Content -->
    <div class="flex-1">
      <div id="appContainer" class="mx-auto flex w-full max-w-6xl flex-col gap-10 px-4 py-8 sm:px-6 lg:px-10 lg:py-12">
        <!-- Login card -->
        <div id="login" class="card mx-auto mt-10 hidden max-w-sm space-y-6 text-center">
          <div class="flex flex-col items-center gap-3">
            <img src="logo.png" alt="Tomos Logo" class="h-16 w-auto rounded-xl" />
            <div>
              <h2 class="text-xl font-semibold text-zinc-900">Admin Access</h2>
              <p class="text-sm text-zinc-500">Sign in to manage your Tomos workspace</p>
            </div>
          </div>
          <div class="space-y-5 text-left">
            <div class="space-y-2">
              <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Email</label>
              <input id="emailInput" type="email" class="w-full rounded-2xl border border-zinc-200 px-4 py-2.5 text-sm text-zinc-900 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" placeholder="admin@company.com" />
            </div>
            <div class="space-y-2">
              <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Password</label>
              <input id="passwordInput" type="password" class="w-full rounded-2xl border border-zinc-200 px-4 py-2.5 text-sm text-zinc-900 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" placeholder="••••••••" />
            </div>
            <button id="btnLogin" class="w-full rounded-full bg-zinc-900 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-zinc-800">Login</button>
            <p id="loginError" class="hidden text-center text-sm text-red-600">❌ Incorrect credentials</p>
          </div>
        </div>

        <!-- Tabs container -->
        <div id="tabs" class="hidden space-y-12">
          <!-- Appearance Tab -->
          <section id="tab-apariencia" class="space-y-10">
            <div id="permBannerA" class="card hidden border border-amber-300 bg-amber-50/70 text-amber-800">
              <div class="flex items-start gap-3">
                <i data-lucide="shield-alert" class="mt-1 h-5 w-5"></i>
                <p class="text-sm"><strong>Sin permisos de escritura.</strong> Debes iniciar sesión con el email guardado en <code>config/adminEmail</code> o ser <code>globalAdmin</code>.</p>
              </div>
            </div>

            <div class="flex flex-col gap-10 xl:flex-row">
              <div class="flex w-full flex-col items-center gap-6 xl:flex-1">
                <div class="flex flex-wrap justify-center gap-3">
                  <button type="button" class="chip appearance-chip" data-appearance-target="header">Header</button>
                  <button type="button" class="chip appearance-chip" data-appearance-target="chat">Chat</button>
                  <button type="button" class="chip appearance-chip" data-appearance-target="widget">Widget</button>
                </div>

                <div class="relative flex flex-col items-center">
                  <div class="relative flex h-[620px] w-[310px] items-center justify-center rounded-[38px] border border-zinc-200 bg-zinc-900 p-4 shadow-xl shadow-black/25">
                    <div class="absolute left-1/2 top-0 h-6 w-40 -translate-x-1/2 rounded-b-3xl bg-zinc-900"></div>
                    <div class="relative h-full w-full overflow-hidden rounded-[28px] bg-white">
                      <iframe id="liveChatFrame" class="absolute inset-0 h-full w-full rounded-[28px] border-0" sandbox="allow-same-origin allow-scripts allow-forms allow-popups" referrerpolicy="no-referrer-when-downgrade"></iframe>
                      <div class="hidden border-b border-zinc-200 bg-white/90 px-4 py-3" id="previewHeader">
                        <div class="flex items-center gap-3">
                          <img id="previewLogo" class="hidden h-7 w-7 rounded-lg" />
                          <span class="text-sm font-medium text-zinc-700">Chat Preview</span>
                        </div>
                      </div>
                      <div class="hidden space-y-3 bg-white/90 px-4 py-5" id="previewHolder">
                        <button id="previewBtn" class="rounded-full px-4 py-2 text-sm text-white">Botón</button>
                        <div id="previewBubble" class="inline-flex max-w-xs rounded-2xl px-4 py-3 text-sm text-white">Mensaje</div>
                      </div>
                    </div>
                  </div>
                  <div id="widgetExampleClone" class="widget-mockup absolute -bottom-24 right-4 z-10">
                    <img id="widgetExampleIconClone" src="widgets/1.png" alt="Widget preview icon" class="h-7 w-7 object-contain" />
                  </div>
                </div>
              </div>

              <div id="appearanceCards" class="flex w-full max-w-xl flex-col gap-6 xl:max-w-sm">
                <div class="appearance-card card hidden space-y-6" data-appearance-card="header">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="panel-top" class="h-5 w-5"></i> Header</div>
                    <button type="button" class="rounded-full p-2 text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-700" data-close-card>
                      <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                  </div>

                  <div class="space-y-6">
                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Image</p>
                      <div class="flex flex-wrap items-center justify-center gap-3" id="logoControls">
                        <label class="flex cursor-pointer items-center gap-2 rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">
                          Select file
                          <input id="logoFile" type="file" accept="image/*" class="hidden" />
                        </label>
                        <button id="deleteLogo" type="button" class="rounded-full border border-zinc-200 px-4 py-2 text-sm text-zinc-600 transition hover:border-zinc-300 hover:text-zinc-900">Remove</button>
                      </div>
                      <div id="logoPreviewWrap" class="hidden">
                        <div class="mx-auto flex h-24 w-24 items-center justify-center overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50 shadow-inner shadow-black/5">
                          <img id="logoPreview" class="h-full w-full object-cover" />
                        </div>
                        <div class="mt-4 flex items-center justify-center gap-3 text-sm text-zinc-600">
                          <label class="flex items-center gap-2"><input type="range" id="logoRadius" min="0" max="30" value="12" class="accent-black" />
                            <span>Radius <span id="logoRadiusVal" class="font-medium text-zinc-900">12</span></span>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Typography</p>
                      <select id="fontFamily" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-700 focus:border-zinc-900 focus:outline-none">
                        <option value="Manrope">Manrope</option>
                        <option value="Inter">Inter</option>
                        <option value="Poppins">Poppins</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Playfair Display">Playfair Display</option>
                        <option value="Merriweather">Merriweather</option>
                      </select>
                    </div>

                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Colors</p>
                      <div class="space-y-3">
                        <label class="flex items-center gap-4 text-sm text-zinc-600">
                          <input id="chatHeaderColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                          Header background
                        </label>
                        <label class="flex items-center gap-4 text-sm text-zinc-600">
                          <input id="headerTextColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                          Text color
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="appearance-card card hidden space-y-6" data-appearance-card="chat">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="message-square" class="h-5 w-5"></i> Chat</div>
                    <button type="button" class="rounded-full p-2 text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-700" data-close-card>
                      <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                  </div>

                  <div class="space-y-6">
                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Avatar</p>
                      <div id="avatarControls" class="space-y-4">
                        <div class="flex flex-wrap items-center gap-3">
                          <button type="button" class="avatar-option active" data-avatar-option="avatars/1.png">
                            <img src="avatars/1.png" alt="Avatar 1" />
                          </button>
                          <button type="button" class="avatar-option" data-avatar-option="avatars/2.png">
                            <img src="avatars/2.png" alt="Avatar 2" />
                          </button>
                          <button type="button" class="avatar-option" data-avatar-option="avatars/3.png">
                            <img src="avatars/3.png" alt="Avatar 3" />
                          </button>
                          <div class="relative">
                            <label id="customAvatarOption" class="avatar-option avatar-upload cursor-pointer" data-avatar-option="">
                              <i id="customAvatarPlus" data-lucide="plus" class="h-5 w-5 text-zinc-400"></i>
                              <img id="customAvatarImage" src="" alt="Custom avatar" class="hidden" />
                              <input id="avatarFile" type="file" accept="image/*" class="hidden" />
                            </label>
                            <button type="button" id="deleteAvatar" class="absolute -right-1 -bottom-1 hidden rounded-full bg-red-600 p-1 text-white shadow hover:bg-red-700">
                              <i data-lucide="trash" class="h-4 w-4"></i>
                            </button>
                          </div>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-zinc-600">
                          <input type="range" id="avatarRadius" min="0" max="50" value="50" class="w-32 accent-black" />
                          <span class="inline-flex items-center gap-1 text-zinc-500">Radius <span id="avatarRadiusVal" class="font-medium text-zinc-900">50</span></span>
                        </div>
                      </div>
                    </div>

                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Font</p>
                      <select id="fontFamily" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-700 focus:border-zinc-900 focus:outline-none">
                        <option value="Manrope">Manrope</option>
                        <option value="Inter">Inter</option>
                        <option value="Poppins">Poppins</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Playfair Display">Playfair Display</option>
                        <option value="Merriweather">Merriweather</option>
                      </select>
                    </div>

                    <div class="space-y-3">
                      <label class="flex items-center gap-4 text-sm text-zinc-600">
                        <input id="chatBackgroundColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                        Chat background
                      </label>
                      <label class="flex items-center gap-4 text-sm text-zinc-600">
                        <input id="chatAssistantTextColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                        Text color
                      </label>
                      <label class="flex items-center gap-4 text-sm text-zinc-600">
                        <input id="chatPrimaryColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                        Client background
                      </label>
                    </div>
                  </div>
                </div>

                <div class="appearance-card card hidden space-y-6" data-appearance-card="widget">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="mouse-pointer" class="h-5 w-5"></i> Widget</div>
                    <button type="button" class="rounded-full p-2 text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-700" data-close-card>
                      <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                  </div>

                  <div class="space-y-6">
                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Icon</p>
                      <div class="flex items-center gap-4">
                        <div id="widgetExample" class="widget-mockup">
                          <img id="widgetExampleIcon" src="widgets/1.png" alt="Widget preview icon" class="h-7 w-7 object-contain" />
                        </div>
                        <button type="button" id="widgetIconTrigger" class="widget-icon-trigger" title="Elegir icono">
                          <img id="widgetIconTriggerImg" src="widgets/1.png" alt="Icono del widget" class="h-7 w-7 object-contain" />
                        </button>
                      </div>
                      <div class="flex items-center gap-3 text-sm text-zinc-600">
                        <label class="flex items-center gap-2">
                          <input type="checkbox" id="widgetRounded" class="rounded border-zinc-300" />
                          Rounded
                        </label>
                        <input type="range" id="widgetRadius" min="0" max="50" value="20" class="flex-1 accent-black" />
                        <span id="widgetRadiusVal" class="inline-block min-w-[2ch] text-right font-medium text-zinc-900">20</span>
                      </div>
                    </div>

                    <div class="space-y-4">
                      <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Colors</p>
                      <label class="flex items-center gap-4 text-sm text-zinc-600">
                        <input id="chatButtonColor" type="color" class="h-10 w-10 cursor-pointer rounded-full border border-zinc-200" />
                        Widget background
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Settings Tab -->
          <section id="tab-settings" class="hidden space-y-8">
            <div id="permBannerS" class="card hidden border border-amber-300 bg-amber-50/70 text-amber-800">
              <div class="flex items-start gap-3">
                <i data-lucide="shield-alert" class="mt-1 h-5 w-5"></i>
                <p class="text-sm"><strong>Sin permisos de escritura.</strong> Debes iniciar sesión con el email guardado en <code>config/adminEmail</code> o ser <code>globalAdmin</code>.</p>
              </div>
            </div>

            <div class="card space-y-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="message-circle" class="h-5 w-5"></i> Show Button</h3>
                  <p class="text-sm text-zinc-500">Show the chat button on the website</p>
                </div>
                <input id="tgChatVisible" type="checkbox" class="toggle" />
              </div>
            </div>

            <div class="card space-y-5">
              <h3 class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="building-2" class="h-5 w-5"></i> General Information</h3>
              <div class="space-y-4">
                <div class="space-y-2">
                  <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Name</label>
                  <input id="hotelName" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-900 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" placeholder="Boletum" />
                </div>
                <div class="space-y-2">
                  <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Time Zone</label>
                  <select id="timeZone" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-900 focus:border-zinc-900 focus:outline-none"></select>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button id="saveGeneral" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Save</button>
                <p id="msgGeneral" class="hidden text-sm text-emerald-600">✔ Saved</p>
              </div>
            </div>

            <div class="card space-y-5">
              <h3 class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="sparkles" class="h-5 w-5"></i> Assistant Personality</h3>
              <div id="personalityChips" class="grid grid-cols-2 gap-3 sm:grid-cols-3">
                <button data-val="formal" class="chip">Formal &amp; Polite</button>
                <button data-val="relaxed" class="chip">Relaxed &amp; Friendly</button>
                <button data-val="warm" class="chip">Warm &amp; Welcoming</button>
                <button data-val="efficient" class="chip">Efficient &amp; Direct</button>
                <button data-val="young" class="chip">Young &amp; Playful</button>
              </div>
            </div>

            <div class="card space-y-5">
              <div class="flex items-center justify-between">
                <h3 class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="smile" class="h-5 w-5"></i> Welcome Message</h3>
                <label class="flex items-center gap-3 text-sm text-zinc-600">
                  Enable
                  <input type="checkbox" id="welcomeEnabled" class="toggle" />
                </label>
              </div>
              <div class="space-y-4">
                <textarea id="welcomeText" class="w-full rounded-3xl border border-zinc-200 px-4 py-3 text-sm text-zinc-700 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" rows="2" placeholder="Enter welcome message..."></textarea>
                <div class="grid gap-4 sm:grid-cols-2">
                  <div class="space-y-2">
                    <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Delay (seconds)</label>
                    <input id="welcomeDelay" type="number" min="0" class="w-28 rounded-2xl border border-zinc-200 px-3 py-2 text-sm text-zinc-700 focus:border-zinc-900 focus:outline-none" value="2" />
                  </div>
                  <div class="space-y-2">
                    <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Welcome image (optional)</label>
                    <input id="welcomeImageFile" type="file" accept="image/*" class="text-sm text-zinc-600" />
                  </div>
                </div>
                <img id="welcomePreview" class="hidden w-48 rounded-2xl border border-zinc-200" />
              </div>
              <div class="flex items-center gap-3">
                <button id="saveWelcome" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Save</button>
                <p id="msgWelcome" class="hidden text-sm text-emerald-600">✔ Saved</p>
              </div>
            </div>

            <div class="card space-y-4">
              <h3 class="flex items-center gap-2 text-sm font-semibold text-zinc-800"><i data-lucide="link-2" class="h-5 w-5"></i> Link para probar el chat</h3>
              <div class="flex flex-col gap-3 sm:flex-row">
                <input id="chatTestLink" type="text" readonly class="flex-1 rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-2 text-sm text-zinc-700 focus:border-zinc-900 focus:outline-none" />
                <div class="flex gap-2">
                  <button id="copyChatLink" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Copiar</button>
                  <button id="openChatLink" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Abrir</button>
                </div>
              </div>
              <p class="text-xs text-zinc-500">El enlace se genera automáticamente con el nombre de tu empresa actual.</p>
            </div>
          </section>

          <!-- Knowledge Tab -->
          <section id="tab-knowledge" class="hidden space-y-8">
            <div class="card space-y-5">
              <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800">
                <i data-lucide="book-open" class="h-5 w-5"></i>
                Knowledge
              </div>
              <p class="text-sm text-zinc-500">Add the contextual information that helps the assistant understand your business, products, and brand tone. You can import pages from a URL and edit them here.</p>
              <div class="flex flex-wrap items-center gap-2">
                <div id="knowledgeTabs" class="flex flex-wrap items-center gap-2"></div>
                <button id="addKnowledgePage" class="inline-flex items-center gap-2 rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">
                  <i data-lucide="plus" class="h-4 w-4"></i>
                  Add
                </button>
              </div>
              <div id="knowledgeUrlMeta" class="hidden text-xs text-zinc-500">
                <span class="font-medium text-zinc-700">Source:</span>
                <span id="knowledgeCurrentUrl" class="truncate"></span>
              </div>
              <textarea id="contextText" class="w-full rounded-3xl border border-zinc-200 px-4 py-3 text-sm text-zinc-700 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" placeholder="Add your knowledge here... (max 10,000 characters)"></textarea>
              <div class="flex items-center justify-between text-xs text-zinc-500">
                <span id="ctxCounter">0 / 10000 characters</span>
                <div class="flex items-center gap-2 text-sm">
                  <button id="deleteKnowledgePage" class="flex items-center gap-1 rounded-full border border-zinc-200 px-3 py-1.5 text-sm text-zinc-600 transition hover:border-red-300 hover:text-red-600" title="Delete page" aria-label="Delete knowledge page">
                    <i data-lucide="trash" class="h-4 w-4"></i>
                  </button>
                  <button id="saveContext" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Save</button>
                </div>
              </div>
              <p id="msgContext" class="hidden text-sm text-emerald-600">✔ Saved</p>
            </div>
          </section>

          <!-- Schedule Tab -->
          <section id="tab-schedule" class="hidden space-y-8">
            <div class="card space-y-5">
              <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800">
                <i data-lucide="clock" class="h-5 w-5"></i>
                Schedule
              </div>
              <p class="text-sm text-zinc-500">Define the periods when the chat widget should be active.</p>
              <div id="scheduleList" class="space-y-3"></div>
              <button id="saveSchedule" class="hidden"></button>
              <p id="msgSchedule" class="hidden text-sm text-emerald-600">✔ Saved</p>
            </div>
          </section>

          <!-- Integration Tab -->
          <section id="tab-integration" class="hidden space-y-8">
            <div class="card space-y-5">
              <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800">
                <i data-lucide="code-2" class="h-5 w-5"></i>
                Integration
              </div>
              <p class="text-sm text-zinc-500">Embed the Tomos widget on your website by placing this script before the closing <code>&lt;/body&gt;</code> tag.</p>
              <div class="rounded-2xl border border-zinc-200 bg-zinc-50 p-4">
                <textarea id="embedScriptBox" class="w-full bg-transparent text-xs font-mono text-zinc-700 focus:outline-none" readonly></textarea>
              </div>
              <div class="flex flex-wrap gap-3">
                <button id="copyEmbedScript" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Copy embed code</button>
                <button id="openDocs" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">View documentation</button>
              </div>
              <p id="embedMsg" class="hidden text-sm text-emerald-600">✔ Copied</p>
            </div>
          </section>

          <!-- Auto Responses Tab -->
          <section id="tab-respuestas" class="hidden space-y-8">
            <div class="card space-y-6">
              <div class="flex flex-col gap-4">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div class="flex items-center gap-2 text-sm font-semibold text-zinc-800">
                    <i data-lucide="bot" class="h-5 w-5"></i>
                    Auto Responses
                  </div>
                  <button id="addAutoResponse" class="inline-flex items-center gap-2 rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">
                    <span class="text-base leading-none">＋</span>
                    <span>New tab</span>
                  </button>
                </div>
                <p class="text-sm text-zinc-500">Organize quick replies for frequent questions. Create as many tabs as you need and preview how they will look inside the chat widget.</p>
                <div id="autoResponseTabs" class="flex w-full flex-nowrap items-center gap-2 overflow-x-auto pb-1"></div>
                <div id="autoResponseEmpty" class="rounded-3xl border border-dashed border-zinc-300 px-6 py-10 text-center text-sm text-zinc-500">Start by creating your first tab to design an automated reply.</div>
                <div id="autoResponsePlaceholder" class="hidden rounded-3xl border border-dashed border-zinc-300 px-6 py-10 text-center text-sm text-zinc-500">Select a tab to review or edit its configuration.</div>
              </div>

              <div id="autoResponseEditor" class="hidden space-y-6">
                <div class="space-y-6 rounded-3xl border border-zinc-200 bg-white/80 p-6 shadow-sm">
                  <div class="grid gap-5 lg:grid-cols-[1.2fr_1fr] lg:items-start">
                    <div class="space-y-4">
                      <div class="space-y-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Keyword</label>
                        <input id="autoResponseKeyword" type="text" placeholder="e.g. spa, restaurant" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
                        <p class="text-[12px] text-zinc-500">When the guest mentions this keyword, the auto response will be triggered.</p>
                      </div>
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Response type</label>
                      <div id="autoResponseType" class="grid grid-cols-3 gap-2 rounded-2xl bg-zinc-100 p-1 text-sm font-medium">
                        <button data-type="text" class="typeOption inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 transition hover:bg-white">
                          <i data-lucide="message-square-text" class="h-4 w-4"></i>
                          <span>Text</span>
                        </button>
                        <button data-type="cards" class="typeOption inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 transition hover:bg-white">
                          <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                          <span>Cards</span>
                        </button>
                        <button data-type="menu" class="typeOption inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 transition hover:bg-white">
                          <i data-lucide="list" class="h-4 w-4"></i>
                          <span>Menu</span>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div id="textEditor" class="space-y-5">
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Message</label>
                      <textarea id="autoResponseText" rows="3" placeholder="Write the automatic response..." class="w-full rounded-2xl border border-zinc-200 px-4 py-3 text-sm text-zinc-700 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none"></textarea>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                      <div class="space-y-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Title</label>
                        <input id="autoResponseTitle" type="text" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
                      </div>
                      <div class="space-y-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Subtitle</label>
                        <input id="autoResponseSubtitle" type="text" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
                      </div>
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Image URL (optional)</label>
                      <input id="autoResponseImage" type="text" placeholder="https://..." class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
                    </div>
                    <div class="space-y-3">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-zinc-700">Buttons</span>
                        <button id="addTextButton" class="rounded-full border border-zinc-200 px-3 py-1 text-xs font-medium text-zinc-600 transition hover:border-zinc-300 hover:text-zinc-900">+ Add button</button>
                      </div>
                      <div id="textButtonsList" class="space-y-2"></div>
                    </div>
                    <div class="space-y-2">
                      <span class="text-sm font-semibold text-zinc-700">Live preview</span>
                      <div id="textPreview" class="flex justify-center rounded-3xl border border-zinc-200 bg-zinc-50 p-6"></div>
                    </div>
                  </div>

                  <div id="cardsEditor" class="hidden space-y-3">
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-semibold text-zinc-700">Cards</span>
                      <button id="addCardButton" class="rounded-full border border-zinc-200 px-3 py-1 text-xs font-medium text-zinc-600 transition hover:border-zinc-300 hover:text-zinc-900">+ Add card</button>
                    </div>
                    <div id="cardsList" class="space-y-3"></div>
                  </div>

                  <div id="menuEditor" class="hidden space-y-3">
                    <div class="space-y-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Intro text</label>
                      <input id="menuIntroText" type="text" placeholder="Choose an option" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
                    </div>
                    <div class="space-y-3">
                      <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold text-zinc-700">Buttons</span>
                        <button id="addMenuButton" class="rounded-full border border-zinc-200 px-3 py-1 text-xs font-medium text-zinc-600 transition hover:border-zinc-300 hover:text-zinc-900">+ Add button</button>
                      </div>
                      <div id="menuButtonsList" class="space-y-2"></div>
                    </div>
                    <div class="space-y-2">
                      <span class="text-sm font-semibold text-zinc-700">Preview</span>
                      <div id="menuPreview" class="flex flex-wrap gap-2 rounded-3xl border border-zinc-200 bg-zinc-50 p-4"></div>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-end gap-3">
                  <button id="saveAutoResponses" class="inline-flex items-center gap-2 rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">
                    <i data-lucide="save"></i>
                    Save changes
                  </button>
                  <button id="deleteAutoResponse" class="rounded-full p-2 text-red-600 transition hover:bg-red-50" aria-label="Delete this tab" title="Delete this tab">
                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                  </button>
                </div>
              </div>
            </div>
            <p id="msgAutoResponses" class="hidden text-sm text-emerald-600">✔ Saved</p>
          </section>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 top-20 z-[9999] -translate-x-1/2 opacity-0"></div>

  <!-- Cropper Modal -->
  <div id="cropperModal" class="fixed inset-0 z-[9998] hidden items-center justify-center bg-black/60 px-4">
    <div class="card max-w-sm space-y-5 text-center">
      <h3 class="text-lg font-semibold text-zinc-900">Crop Header Image</h3>
      <div class="flex aspect-square w-full items-center justify-center overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50">
        <img id="cropperImage" class="max-h-[320px] max-w-full" />
      </div>
      <div id="logoProgressWrap" class="hidden w-full overflow-hidden rounded-full bg-zinc-200">
        <div id="logoBar" class="h-2 w-0 bg-zinc-900 transition-all duration-200"></div>
      </div>
      <div class="flex justify-center gap-3">
        <button id="cancelCrop" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Cancel</button>
        <button id="confirmCrop" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Save</button>
      </div>
    </div>
  </div>

  <!-- Knowledge Modal -->
  <div id="knowledgeModal" class="fixed inset-0 z-[1200] hidden items-center justify-center bg-black/40 px-4 backdrop-blur-sm">
    <div class="card relative w-full max-w-xl space-y-5">
      <button id="closeKnowledgeModal" class="absolute right-4 top-4 text-zinc-400 transition hover:text-zinc-600">
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>
      <div class="space-y-2">
        <h3 class="text-lg font-semibold text-zinc-900">Add page</h3>
        <p class="text-sm text-zinc-500">Fetch content from a public URL or create a blank page to train your assistant.</p>
      </div>
      <div class="space-y-3">
        <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Title</label>
        <input id="knowledgeTitleInput" type="text" placeholder="Customer Support" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
      </div>
      <div class="space-y-3">
        <label class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Page URL</label>
        <input id="knowledgeUrlInput" type="url" placeholder="https://example.com/page" class="w-full rounded-2xl border border-zinc-200 px-4 py-2 text-sm text-zinc-800 shadow-inner shadow-black/5 focus:border-zinc-900 focus:outline-none" />
      </div>
      <p id="knowledgeModalError" class="hidden text-sm text-red-600"></p>
      <p id="knowledgeModalStatus" class="hidden text-sm text-zinc-500"></p>
      <div class="flex items-center justify-end gap-3 pt-2">
        <button id="cancelKnowledgeModal" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Cancel</button>
        <button id="confirmAddKnowledge" class="inline-flex items-center gap-2 rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">
          <span>Add</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Knowledge Delete Modal -->
  <div id="knowledgeDeleteModal" class="fixed inset-0 z-[1200] hidden items-center justify-center bg-black/40 px-4 backdrop-blur-sm">
    <div class="card relative w-full max-w-md space-y-5">
      <button id="closeKnowledgeDeleteModal" class="absolute right-4 top-4 text-zinc-400 transition hover:text-zinc-600">
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>
      <div class="flex items-start gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-red-50 text-red-600">
          <i data-lucide="trash-2" class="h-5 w-5"></i>
        </div>
        <div class="space-y-2">
          <h3 class="text-lg font-semibold text-zinc-900">Delete knowledge page</h3>
          <p class="text-sm text-zinc-600">Are you sure you want to delete <span id="deleteKnowledgePageTitle" class="font-medium text-zinc-900"></span>? This action cannot be undone.</p>
        </div>
      </div>
      <div class="flex items-center justify-end gap-3">
        <button id="cancelDeleteKnowledge" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Cancel</button>
        <button id="confirmDeleteKnowledge" class="rounded-full bg-red-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>
<script>
// ====== Firebase config ======
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyC2c3S_NtouIjHPrk5LM5c0DQoTWyBrzH4",
  authDomain: "timbre-c9547.firebaseapp.com",
  databaseURL: "https://timbre-c9547-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "timbre-c9547",
  storageBucket: "timbre-c9547.firebasestorage.app",
  messagingSenderId: "127064655657",
  appId: "1:127064655657:web:a4e99dcbc6ab33f32c1938"
};
if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
const auth = firebase.auth();
const storage = firebase.storage();

const DEFAULT_WIDGET_ICON = 'widgets/1.png';
let currentWidgetIcon = DEFAULT_WIDGET_ICON;

// ====== Helpers ======
const $ = (id) => document.getElementById(id);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
function toast(msg){
  const t = $('toast');
  t.textContent = msg;
  t.classList.remove('opacity-0');
  setTimeout(() => t.classList.add('opacity-0'), 2500);
}

function getEmpresa() {
  const url = new URL(window.location.href);
  const p = (url.searchParams.get('empresa') || localStorage.getItem('empresa') || '').trim();
  if (p) localStorage.setItem('empresa', p);
  return p || 'default';
}

let EMPRESA = getEmpresa();
$('empresaBadge').textContent = EMPRESA;
$('empresaText').textContent = EMPRESA;
function eref(path) { return db.ref(`${EMPRESA}/${path}`); }

let canWriteFlag = false;
async function refreshPermissions() {
  const user = auth.currentUser;
  if (!user) { canWriteFlag = false; setWriteEnabled(false); return; }

  $('authEmail').textContent = user.email || '';
  const adminEmailSnap = await eref('config/adminEmail').once('value');
  const adminEmail = adminEmailSnap.val();
  const globalAdminSnap = await db.ref('globalAdmins/' + user.uid).once('value');
  const isGlobal = !!globalAdminSnap.val();

  canWriteFlag = isGlobal || (adminEmail && user.email && adminEmail === user.email);
  setWriteEnabled(canWriteFlag);
  document.getElementById('permBannerA').classList.toggle('hidden', canWriteFlag);
  document.getElementById('permBannerS').classList.toggle('hidden', canWriteFlag);
}

function setWriteEnabled(enabled) {
  const ids = [
    'saveChatPrimaryColor','saveChatButtonColor','uploadLogo','deleteLogo',
    'uploadAvatar','deleteAvatar','fontSelect','tgChatVisible','hotelName',
    'timeZone','saveGeneral','saveContext','contextText','widgetIconTrigger',
    'addKnowledgePage','knowledgeUrlInput','confirmAddKnowledge'
  ];
  ids.forEach(id => {
    const el = $(id);
    if (!el) return;
    el.disabled = !enabled;
    el.classList.toggle('opacity-60', !enabled);
    el.classList.toggle('cursor-not-allowed', !enabled);
  });
  $$('#personalityChips .chip').forEach(ch => {
    ch.disabled = !enabled;
    ch.classList.toggle('opacity-60', !enabled);
  });

  if (typeof window.__applyKnowledgeWriteState === 'function') {
    window.__applyKnowledgeWriteState();
  }
}

const TAB_KEYS = ['apariencia','settings','knowledge','integration','respuestas','schedule'];
let tabsInitialized = false;

function setActiveTab(tab) {
  const targetTab = TAB_KEYS.includes(tab) ? tab : 'apariencia';

  $$('.sidebar-btn').forEach(btn => {
    const btnTab = btn.getAttribute('data-tab');
    btn.classList.toggle('active', btnTab === targetTab);
  });

  TAB_KEYS.forEach(key => {
    const section = document.getElementById(`tab-${key}`);
    if (section) {
      section.classList.toggle('hidden', key !== targetTab);
    }
  });
}

function showAppView() {
  document.querySelector('header')?.classList.remove('hidden');
  document.querySelector('aside')?.classList.remove('hidden');
  $('headerSpacer')?.classList.remove('hidden');
  $('login').classList.add('hidden');
  $('tabs').classList.remove('hidden');
  $('btnLogout').classList.remove('hidden');
  document.body.classList.add('app-view');
  document.body.classList.remove('login-view');
}

function showLoginView() {
  document.querySelector('header')?.classList.add('hidden');
  document.querySelector('aside')?.classList.add('hidden');
  $('headerSpacer')?.classList.add('hidden');
  $('login').classList.remove('hidden');
  $('tabs').classList.add('hidden');
  $('btnLogout').classList.add('hidden');
  document.body.classList.add('login-view');
  document.body.classList.remove('app-view');
  setActiveTab('apariencia');
}

async function canWrite(fn) {
  await refreshPermissions();
  if (!canWriteFlag) {
    alert('You do not have permission to modify the configuration.');
    return;
  }
  await fn();
}

// ====== Auth ======
$('btnLogin').addEventListener('click', async () => {
  const email = $('emailInput').value.trim();
  const pass = $('passwordInput').value.trim();
  if (!email || !pass) return alert('Please enter your credentials.');
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (e) {
    console.error(e);
    $('loginError').classList.remove('hidden');
  }
});

$('btnLogout').addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async (u) => {
  if (u) {
    // 🔍 Detect company automatically by user email
    let empresaDetectada = null;
    try {
      const snapshot = await db.ref().once('value');
      const data = snapshot.val() || {};
      for (const emp in data) {
        const adminEmail = data[emp]?.config?.adminEmail;
        if (adminEmail && adminEmail.toLowerCase() === u.email.toLowerCase()) {
          empresaDetectada = emp;
          break;
        }
      }
    } catch (err) {
      console.error('Error finding company:', err);
    }

    if (empresaDetectada) {
      EMPRESA = empresaDetectada;
      localStorage.setItem('empresa', EMPRESA);
      $('empresaBadge').textContent = EMPRESA;
      $('empresaText').textContent = EMPRESA;
      console.log('✅ Company detected automatically:', EMPRESA);
    } else {
      console.warn('⚠ No company found for this email, using previous value:', EMPRESA);
    }

    showAppView();

    await initAll();

    // ✅ Mostrar chat en vivo dentro del mockup
    const live = document.getElementById('liveChatFrame');
    if (live && EMPRESA) {
      live.src = `https://tomos.bot/chat.html?empresa=${encodeURIComponent(EMPRESA)}`;
      console.log('💬 Live chat loaded for', EMPRESA);
    }

  } else {
    showLoginView();
  }

  $('pageLoader').style.display = 'none';
});


// ====== Tabs ======
function initTabs() {
  if (tabsInitialized) {
    setActiveTab('apariencia');
    return;
  }

  tabsInitialized = true;
  setActiveTab('apariencia');

  $$('.sidebar-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      if (!tab) return;
      setActiveTab(tab);
    });
  });
}

// ====== Timezones ======
function getTimeZones(){
  if (Intl.supportedValuesOf) { try { return Intl.supportedValuesOf('timeZone'); } catch(e){} }
  return [
    'Europe/Madrid','Europe/Lisbon','Europe/Paris','Europe/Berlin','Europe/Rome','Europe/Warsaw','Eurris','Europe/Berlin','Europe/Rome','Europe/Warsaw','Europe/London',
    'America/Santiago','America/Sao_Paulo','America/Mexico_City','America/Bogota','America/Lima','America/Argentina/Buenos_Aires',
    'America/New_York','America/Los_Angeles','America/Chicago',
    'Africa/Mauritius','Indian/Mauritius',
    'Asia/Dubai','Asia/Singapore','Asia/Tokyo','Asia/Kolkata','Australia/Sydney'
  ];
}

// ====== Init All ======
async function initAll(){
  lucide.createIcons(); 
  initTabs(); 
  applyPreview(); 
  await refreshPermissions();
  initApariencia(); 
  initSettingsTab(); 
  initKnowledge();
  initIntegration();
  initRespuestas();
  initWelcome();
  initSchedule();




}


// ====== Apariencia ======
function initApariencia() {

  const chips = Array.from(document.querySelectorAll('[data-appearance-target]'));
  const cards = Array.from(document.querySelectorAll('[data-appearance-card]'));

  const clearAppearanceCards = () => {
    chips.forEach(chip => chip.classList.remove('active'));
    cards.forEach(card => card.classList.add('hidden'));
  };

  const openAppearanceCard = (name) => {
    chips.forEach(chip => chip.classList.toggle('active', chip.dataset.appearanceTarget === name));
    cards.forEach(card => card.classList.toggle('hidden', card.dataset.appearanceCard !== name));
  };

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      const target = chip.dataset.appearanceTarget;
      const isActive = chip.classList.contains('active');
      clearAppearanceCards();
      if (!isActive) {
        openAppearanceCard(target);
      }
    });
  });

  document.querySelectorAll('[data-close-card]').forEach(btn => {
    btn.addEventListener('click', () => {
      clearAppearanceCards();
    });
  });

// 🔹 Chat Primary Color (auto-save with toast)
const prRef = eref('config/chatPrimaryColor');
prRef.once('value', s => {
  $('chatPrimaryColor').value = s.val() || '#111111';
  applyPreview();
});

$('chatPrimaryColor').addEventListener('input', (e) => {
  const v = e.target.value || '#111111';
  canWrite(async () => {
    await prRef.set(v);
    applyPreview();
    toast('✔ Primary color saved');
  });
});

// 🔹 Chat Button Color (auto-save with toast)
const btRef = eref('config/chatButtonColor');
btRef.once('value', s => {
  $('chatButtonColor').value = s.val() || '#111111';
  applyPreview();
});

$('chatButtonColor').addEventListener('input', (e) => {
  const v = e.target.value || '#111111';
  canWrite(async () => {
    await btRef.set(v);
    applyPreview();
    toast('✔ Button color saved');
  });
});

const widgetExample = $('widgetExample');
const widgetExampleIcon = $('widgetExampleIcon');
const widgetIconTriggerImg = $('widgetIconTriggerImg');
const widgetIconModal = $('widgetIconModal');
const widgetIconTrigger = $('widgetIconTrigger');
const closeWidgetIconModal = $('closeWidgetIconModal');
const widgetIconOptions = $$('.widget-icon-option');
const widgetIconRef = eref('config/widgetIcon');

const updateWidgetPreview = () => {
  const color = $('chatButtonColor')?.value || '#111111';
  const radiusVal = parseInt($('widgetRadius')?.value) || 20;

  // Aplica a ambos mockups: el original y el clon
  [ $('widgetExample'), $('widgetExampleClone') ].forEach(el => {
    if (!el) return;
    el.style.background = color;
    el.style.borderRadius = radiusVal + 'px';
  });

  // Actualiza iconos en ambos + en el botón selector
  [ $('widgetExampleIcon'), $('widgetExampleIconClone'), $('widgetIconTriggerImg') ].forEach(img => {
    if (!img) return;
    img.src = currentWidgetIcon || DEFAULT_WIDGET_ICON;
  });
};

updateWidgetPreview();

const closeWidgetModal = () => {
  if (!widgetIconModal) return;
  widgetIconModal.classList.add('hidden');
  widgetIconModal.classList.remove('flex');
};

const openWidgetModal = () => {
  if (!widgetIconModal) return;
  widgetIconModal.classList.remove('hidden');
  widgetIconModal.classList.add('flex');
};

widgetIconTrigger?.addEventListener('click', openWidgetModal);
closeWidgetIconModal?.addEventListener('click', closeWidgetModal);
widgetIconModal?.addEventListener('click', (e) => {
  if (e.target === widgetIconModal) closeWidgetModal();
});

const applyWidgetIcon = (iconPath) => {
  const finalIcon = (iconPath || '').trim() || DEFAULT_WIDGET_ICON;
  currentWidgetIcon = finalIcon;
  widgetIconOptions.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.widgetIcon === finalIcon);
  });
  updateWidgetPreview();
};

widgetIconRef.once('value', snap => {
  applyWidgetIcon(snap.val());
  updateWidgetPreview();
});

widgetIconOptions.forEach(btn => {
  btn.addEventListener('click', () => {
    const icon = btn.dataset.widgetIcon;
    if (!icon) return;
    canWrite(async () => {
      await widgetIconRef.set(icon);
      applyWidgetIcon(icon);
      closeWidgetModal();
      toast('✔ Widget icon updated');
      applyPreview();
    });
  });
});

// === Widget Border Radius ===
const widgetRadiusRef = eref('config/widgetRadius');

widgetRadiusRef.once('value', s => {
  const v = s.val() || 20;
  $('widgetRadius').value = v;
  $('widgetRadiusVal').textContent = v;
  updateWidgetPreview();
});

$('widgetRadius').addEventListener('input', (e) => {
  const val = parseInt(e.target.value);
  $('widgetRadiusVal').textContent = val;
  canWrite(async () => {
    await widgetRadiusRef.set(val);
    toast('✔ Widget border updated');
  });
  updateWidgetPreview();
  applyPreview();
});


// 🔹 Chat Background Color (auto-save with toast)
const bgRef = eref('config/chatBackgroundColor');
bgRef.once('value', s => {
  $('chatBackgroundColor').value = s.val() || '#ffffff';
  applyPreview();
});

$('chatBackgroundColor').addEventListener('input', (e) => {
  const v = e.target.value || '#ffffff';
  canWrite(async () => {
    await bgRef.set(v);
    applyPreview();
    toast('✔ Background color saved');
  });
});


// 🆕 Assistant Text Color (auto-save with toast)
const atRef = eref('config/chatAssistantTextColor');
atRef.once('value', s => {
  $('chatAssistantTextColor').value = s.val() || '#000000';
  applyPreview();
});

$('chatAssistantTextColor').addEventListener('input', (e) => {
  const v = e.target.value || '#000000';
  canWrite(async () => {
    await atRef.set(v);
    applyPreview();
    toast('✔ Assistant text color saved');
  });
});



// 🔹 Header Background Color (auto-save with toast)
const headerRef = eref('config/chatHeaderColor');
headerRef.once('value', s => {
  $('chatHeaderColor').value = s.val() || '#ffffff';
  applyPreview();
});

$('chatHeaderColor').addEventListener('input', (e) => {
  const v = e.target.value || '#ffffff';
  canWrite(async () => {
    await headerRef.set(v);
    applyPreview();
    toast('✔ Header color saved');
  });
});




// === Logo ===
const logoRef = eref('config/logoUrl');
logoRef.once('value', s => {
  const url = s.val();
  if (url) {
    $('logoPreview').src = url;
    $('logoPreviewWrap').classList.remove('hidden');
    $('logoControls').classList.add('hidden');
    $('previewLogo').src = url;
    $('previewLogo').classList.remove('hidden');
    lucide.createIcons();
  }
});

// 🆙 Subir logo automáticamente al seleccionar archivo
$('logoFile').addEventListener('change', e => canWrite(() => {
  const f = e.target.files[0];
  if (!f) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    // Show cropping modal
    $('cropperImage').src = ev.target.result;
    $('cropperModal').classList.remove('hidden');
    $('cropperModal').classList.add('flex');

    let cropper;
    $('cropperImage').onload = () => {
      cropper = new Cropper($('cropperImage'), {
        aspectRatio: 1,
        viewMode: 1,
        background: false,
        movable: false,
        zoomable: true,
        rotatable: false,
        scalable: false
      });
    };

    $('cancelCrop').onclick = () => {
      cropper.destroy();
      $('cropperModal').classList.add('hidden');
      e.target.value = ''; // clear input
    };

    $('confirmCrop').onclick = async () => {
      const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
      $('cropperModal').classList.add('hidden');
      cropper.destroy();

      const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
      const path = `logos/${EMPRESA}_${Date.now()}.jpg`;
      const ref = storage.ref(path);
      const task = ref.put(blob);

      $('logoProgressWrap').classList.remove('hidden');
      task.on('state_changed', s => {
        const p = Math.round((s.bytesTransferred / s.totalBytes) * 100);
        $('logoBar').style.width = p + '%';
        $('logoBar').style.background = $('chatPrimaryColor').value || '#111';
      }, console.error, async () => {
        const url = await ref.getDownloadURL();
        await logoRef.set(url);
        $('logoPreview').src = url;
        $('logoPreviewWrap').classList.remove('hidden');
        $('logoControls').classList.add('hidden');
        $('previewLogo').src = url;
        $('previewLogo').classList.remove('hidden');
        $('logoProgressWrap').classList.add('hidden');
        toast('✔ Header image updated'); // ✅ only toast
        e.target.value = ''; // clear input
        lucide.createIcons();
      });
    };
  };
  reader.readAsDataURL(f);
}));

// 🗑️ Eliminar logo
$('deleteLogo').onclick = () => canWrite(async () => {
  await logoRef.set('');
  $('logoPreviewWrap').classList.add('hidden');
  $('logoControls').classList.remove('hidden');
  $('previewLogo').classList.add('hidden');
  toast('Logo eliminado');
});

// === Logo Border Radius ===
const radiusRef = eref('config/logoRadius');

// Cargar valor inicial
radiusRef.once('value', s => {
  const v = s.val() || 0;
  if ($('logoRadius')) {
    $('logoRadius').value = v;
    $('logoRadiusVal').textContent = v;
  }
  $('logoPreview').style.borderRadius = `${v}%`;
  $('previewLogo').style.borderRadius = `${v}%`;
});

// 🔥 Guardar automáticamente al mover el deslizador
if ($('logoRadius')) {
  $('logoRadius').addEventListener('input', (e) => {
    const val = parseInt(e.target.value);
    $('logoRadiusVal').textContent = val;
    $('logoPreview').style.borderRadius = `${val}%`;
    $('previewLogo').style.borderRadius = `${val}%`;

    // Guardar en Firebase solo si se tienen permisos
    canWrite(async () => {
      await radiusRef.set(val);
      toast('✔ Borders updated');
    });
  });
}



// === Typography (picker visual) ===
const fontRef = eref('config/fontFamily');
const fonts = ["Manrope","Inter","Poppins","Roboto","Playfair Display","Merriweather"];

fontRef.once('value', s => {
  const f = s.val() || 'Manrope';

  // ✅ Mostrar fuente guardada en el <select>
  const select = $('fontFamily');
  if (select) select.value = f;

  // ✅ Si el picker visual ya existe, actualizar el texto y la vista previa
  const span = document.getElementById('fontSelected');
  if (span) {
    span.textContent = f;
    span.style.fontFamily = `'${f}', system-ui, sans-serif`;
  }

  // ✅ Aplicar solo al mockup, no al panel
  $('previewBubble').style.fontFamily = `'${f}', system-ui, sans-serif`;
  $('previewBtn').style.fontFamily = `'${f}', system-ui, sans-serif`;
});

const select = $('fontFamily');
if (select) {
  const wrapper = document.createElement("div");
  wrapper.className = "relative";
  const button = document.createElement("button");
  button.type = "button";
  button.className = "w-full border rounded px-3 py-2 text-left bg-white flex justify-between items-center";
  button.innerHTML = `<span id="fontSelected" style="font-family: '${select.value}', system-ui;">${select.value}</span>
                      <svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 ml-2' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                        <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/>
                      </svg>`;
  const list = document.createElement("div");
  list.className = "absolute mt-1 w-full bg-white border rounded-lg shadow z-50 hidden";

  fonts.forEach(font => {
    const item = document.createElement("div");
    item.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm";
    item.style.fontFamily = `'${font}', system-ui, sans-serif`;
    item.textContent = font;
    item.onclick = async () => {
      select.value = font;
      $('fontSelected').textContent = font;
      $('fontSelected').style.fontFamily = `'${font}', system-ui, sans-serif`;
      list.classList.add("hidden");

      await canWrite(async () => {
        await fontRef.set(font);
        $('previewBubble').style.fontFamily = `'${font}', system-ui, sans-serif`;
        $('previewBtn').style.fontFamily = `'${font}', system-ui, sans-serif`;
        toast('✔ Font saved');

        // 🔄 Refrescar mockup
// ✨ Actualizar fuente sin recargar el iframe
const iframe = document.getElementById('liveChatFrame');
if (iframe?.contentWindow?.document) {
  try {
    const doc = iframe.contentWindow.document;
    const chatRoot = doc.body || doc.documentElement;
    if (chatRoot) {
      chatRoot.style.fontFamily = `'${font}', system-ui, sans-serif`;
    }
  } catch (err) {
    console.warn("⚠️ No se pudo acceder al iframe directamente (dominio cruzado), se omite actualización en vivo.");
  }
}

      });
    };
    list.appendChild(item);
  });

  wrapper.appendChild(button);
  wrapper.appendChild(list);
  select.insertAdjacentElement("afterend", wrapper);
  select.style.display = "none";

  button.onclick = () => list.classList.toggle("hidden");
  document.addEventListener("click", e => {
    if (!wrapper.contains(e.target)) list.classList.add("hidden");
  });
}




  // === Avatar ===
  const DEFAULT_AVATAR = 'avatars/1.png';
  const avatarButtons = Array.from(document.querySelectorAll('[data-avatar-option]'));
  const avRef = eref('config/avatarUrl');
  const customAvatarOption = $('customAvatarOption');
  const customAvatarImage = $('customAvatarImage');
  const customAvatarPlus = $('customAvatarPlus');
  const deleteAvatarBtn = $('deleteAvatar');
  const presetAvatarUrls = avatarButtons
    .filter(btn => !btn.classList.contains('avatar-upload'))
    .map(btn => (btn.dataset.avatarOption || '').trim())
    .filter(Boolean);
  let currentAvatar = DEFAULT_AVATAR;
  let avatarMsgTimeout;

  const updateCustomAvatarUI = (url) => {
    if (!customAvatarOption || !customAvatarImage || !customAvatarPlus) return;
    const finalUrl = (typeof url === 'string' ? url.trim() : '');

    if (finalUrl) {
      customAvatarOption.dataset.avatarOption = finalUrl;
      customAvatarImage.src = finalUrl;
      customAvatarImage.classList.remove('hidden');
      customAvatarPlus.classList.add('hidden');
      if (deleteAvatarBtn) deleteAvatarBtn.classList.remove('hidden');
    } else {
      customAvatarOption.dataset.avatarOption = '';
      customAvatarImage.removeAttribute('src');
      customAvatarImage.classList.add('hidden');
      customAvatarPlus.classList.remove('hidden');
      if (deleteAvatarBtn) deleteAvatarBtn.classList.add('hidden');
    }
  };

  updateCustomAvatarUI('');

  if (customAvatarOption) {
    customAvatarOption.addEventListener('click', e => {
      if ((customAvatarOption.dataset.avatarOption || '').trim()) {
        e.preventDefault();
      }
    });
  }

  const applyAvatarSelection = (value) => {
    const finalUrl = (typeof value === 'string' ? value.trim() : '') || DEFAULT_AVATAR;
    currentAvatar = finalUrl;

    if (!presetAvatarUrls.includes(finalUrl)) {
      updateCustomAvatarUI(finalUrl);
    }

    avatarButtons.forEach(btn => {
      const data = (btn.dataset.avatarOption || '').trim();
      const isMatch = data && data === finalUrl;
      btn.classList.toggle('active', isMatch);
    });
  };


  applyAvatarSelection(DEFAULT_AVATAR);

  avRef.once('value', s => {
    const url = s.val();
    applyAvatarSelection(url || DEFAULT_AVATAR);
  });

  avatarButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const selected = (btn.dataset.avatarOption || '').trim();
      if (!selected || currentAvatar === selected) return;

      canWrite(async () => {
        await avRef.set(selected);
        applyAvatarSelection(selected);
toast('✔ Avatar updated');
      });
    });
  });

  const updateAvatarRadius = (value) => {
    document.documentElement.style.setProperty('--avatar-radius', `${value}%`);
  };

  const avatarRadiusRef = eref('config/avatarRadius');
  avatarRadiusRef.once('value', s => {
    const stored = s.val();
    const parsed = typeof stored === 'number' ? stored : parseInt(stored, 10);
    const radius = Number.isFinite(parsed) ? parsed : 50;
    $('avatarRadius').value = radius;
    $('avatarRadiusVal').textContent = radius;
    updateAvatarRadius(radius);
  });

  $('avatarRadius').addEventListener('input', e => {
    const val = parseInt(e.target.value, 10);
    if (!Number.isFinite(val)) return;
    $('avatarRadiusVal').textContent = val;
    updateAvatarRadius(val);

    canWrite(async () => {
      await avatarRadiusRef.set(val);
      toast('✔ Avatar border updated');
    });
  });

  // 🆙 Subir avatar con recorte cuadrado (1:1)
  $('avatarFile').addEventListener('change', e => canWrite(() => {
    const f = e.target.files[0];
    if (!f) return;

    const reader = new FileReader();
    reader.onload = ev => {
      $('cropperImageAvatar').src = ev.target.result;
      $('cropperModalAvatar').classList.remove('hidden');
      $('cropperModalAvatar').classList.add('flex');

      let cropper;
      $('cropperImageAvatar').onload = () => {
        cropper = new Cropper($('cropperImageAvatar'), {
          aspectRatio: 1,
          viewMode: 1,
          background: false,
          movable: false,
          zoomable: true,
          rotatable: false,
          scalable: false
        });
      };

      $('cancelCropAvatar').onclick = () => {
        cropper.destroy();
        $('cropperModalAvatar').classList.add('hidden');
        e.target.value = '';
      };

      $('confirmCropAvatar').onclick = async () => {
        const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
        $('cropperModalAvatar').classList.add('hidden');
        cropper.destroy();

        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
        const path = `avatars/${EMPRESA}_${Date.now()}.jpg`;
        const ref = storage.ref(path);
        const task = ref.put(blob);

        $('avatarProgressWrap').classList.remove('hidden');
        task.on('state_changed', s => {
          const p = Math.round((s.bytesTransferred / s.totalBytes) * 100);
          $('avatarBar').style.width = p + '%';
          $('avatarBar').style.background = $('chatPrimaryColor').value || '#111';
        }, console.error, async () => {
          const url = await ref.getDownloadURL();
          await avRef.set(url);
          applyAvatarSelection(url);
          $('avatarProgressWrap').classList.add('hidden');
toast('✔ Avatar updated');
          e.target.value = '';
          lucide.createIcons();
        });
      };
    };
    reader.readAsDataURL(f);
  }));

  // 🗑️ Eliminar avatar
  if (deleteAvatarBtn) {
    deleteAvatarBtn.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();

      if (!customAvatarOption || !(customAvatarOption.dataset.avatarOption || '').trim()) return;

      canWrite(async () => {
        await avRef.set(DEFAULT_AVATAR);
        updateCustomAvatarUI('');
        applyAvatarSelection(DEFAULT_AVATAR);
        toast('Avatar restored');
      });
    });
  }
}

function applyPreview() {
  const p = $('chatPrimaryColor')?.value || '#111111';
  const b = $('chatButtonColor')?.value || p;
  const bg = $('chatBackgroundColor')?.value || '#ffffff';
  const at = $('chatAssistantTextColor')?.value || '#000000';

  // 🎨 Vista previa del chat dentro del mockup
  $('previewBtn').style.background = b;
  $('previewBubble').style.background = p;

  // 🎨 Widget principal
  const widgetExample = $('widgetExample');
  if (widgetExample) {
    const radiusVal = parseInt($('widgetRadius')?.value) || 20;
    widgetExample.style.background = b;
    widgetExample.style.borderRadius = radiusVal + 'px';
  }

  // 🧩 Nuevo: aplicar cambios también al clon del widget debajo del mockup
  const widgetExampleClone = $('widgetExampleClone');
  if (widgetExampleClone) {
    const radiusVal = parseInt($('widgetRadius')?.value) || 20;
    widgetExampleClone.style.background = b;
    widgetExampleClone.style.borderRadius = radiusVal + 'px';
  }

  // 🔁 Actualizar íconos en ambos mockups y en el selector
  const widgetExampleIcon = $('widgetExampleIcon');
  const widgetExampleIconClone = $('widgetExampleIconClone');
  const widgetIconTriggerImg = $('widgetIconTriggerImg');

  [widgetExampleIcon, widgetExampleIconClone, widgetIconTriggerImg].forEach(img => {
    if (img) img.src = currentWidgetIcon || DEFAULT_WIDGET_ICON;
  });

  // 🪄 Fondo y texto dentro del iframe del chat
  const iframe = document.getElementById('liveChatFrame');
  if (iframe?.contentWindow?.document) {
    try {
      const doc = iframe.contentWindow.document;
      const chatRoot = doc.querySelector('#chatWindow');
      if (chatRoot) chatRoot.style.background = bg;

      // 🆕 Color del texto de los mensajes del asistente
      const msgs = doc.querySelectorAll('.chat-assistant .msg');
      msgs.forEach(m => m.style.color = at);
    } catch (err) {
      console.warn("⚠️ No se pudo aplicar colores en el iframe (dominio cruzado).");
    }
  }
}

// ====== Settings Tab ======
function initSettingsTab(){
  // Toggle show button
  const visRef = eref('config/chatVisible');
  visRef.once('value', s=> $('tgChatVisible').checked = !!s.val());
  $('tgChatVisible').addEventListener('change', ()=> canWrite(async ()=>{ await visRef.set(!!$('tgChatVisible').checked); }));

  // General Information
  const nameRef = eref('config/hotelName');
  nameRef.once('value', s=> $('hotelName').value = s.val() || '');

  const tzRef = eref('config/timeZone');
  const zones = getTimeZones();
  $('timeZone').innerHTML = zones.map(z=>`<option value="${z}">${z.replace('_',' ')}</option>`).join('');
  tzRef.once('value', s=>{ const v=s.val()||Intl.DateTimeFormat().resolvedOptions().timeZone||'Europe/Madrid'; $('timeZone').value = zones.includes(v)?v:'Europe/Madrid'; });

  $('saveGeneral').onclick = ()=> canWrite(async ()=>{
    await nameRef.set(($('hotelName').value||'').trim());
    await tzRef.set($('timeZone').value);
    $('msgGeneral').classList.remove('hidden'); setTimeout(()=>$('msgGeneral').classList.add('hidden'),1200);
  });

  // Personality chips
  const chips = $$('#personalityChips .chip');
  const persRef = eref('config/personality');
  persRef.once('value', s=>{
    const v=(s.val()||'warm');
    chips.forEach(c=>c.classList.toggle('active', c.dataset.val===v));
  });
  chips.forEach(ch=>{
    ch.addEventListener('click', ()=> canWrite(async ()=>{
      chips.forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      await persRef.set(ch.dataset.val);
    }));
  });
  
  
  function autoResize(t){
  t.style.height='auto';
  t.style.height=t.scrollHeight+'px';
}



  // Chat test link
  const link = `https://tomos.bot/chat.html?empresa=${encodeURIComponent(EMPRESA)}`;
  $('chatTestLink').value = link;
  $('copyChatLink').onclick = ()=>{ navigator.clipboard.writeText(link); toast('Copiado'); };
  $('openChatLink').onclick = ()=> window.open(link, '_blank');
}



function initKnowledge() {
  const pagesRef = eref('config/contextPages');
  const legacyRef = eref('config/contextInfo');

  const txt = $('contextText');
  const btn = $('saveContext');
  const counter = $('ctxCounter');
  const tabsWrap = $('knowledgeTabs');
  const addBtn = $('addKnowledgePage');
  const deleteBtn = $('deleteKnowledgePage');
  const urlMeta = $('knowledgeUrlMeta');
  const urlLabel = $('knowledgeCurrentUrl');

  const modal = $('knowledgeModal');
  const modalClose = $('closeKnowledgeModal');
  const modalCancel = $('cancelKnowledgeModal');
  const modalConfirm = $('confirmAddKnowledge');
  const modalInput = $('knowledgeUrlInput');
  const modalError = $('knowledgeModalError');
  const modalStatus = $('knowledgeModalStatus');

  const deleteModal = $('knowledgeDeleteModal');
  const deleteModalClose = $('closeKnowledgeDeleteModal');
  const deleteModalCancel = $('cancelDeleteKnowledge');
  const deleteModalConfirm = $('confirmDeleteKnowledge');
  const deleteModalTitle = $('deleteKnowledgePageTitle');

  const LIMIT = 10000;

  let pages = [];
  let currentPageId = '';
  let isSaving = false;
  let pageToDeleteId = '';

  const generatePageId = () =>
    `pg_${Math.random().toString(36).slice(2, 8)}${Date.now().toString(36)}`;

  function sanitizeText(text = '') {
    return (text || '')
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .trim();
  }

  function extractScrapedContent(payload) {
    if (!payload) return '';

    if (typeof payload === 'string') return payload;

    if (Array.isArray(payload)) {
      for (const item of payload) {
        const result = extractScrapedContent(item);
        if (result) return result;
      }
      return '';
    }

    if (typeof payload === 'object') {
      if (typeof payload.content === 'string') return payload.content;
      if (Array.isArray(payload.content)) return payload.content.join('\n');
      if (payload.text) return extractScrapedContent(payload.text);
      if (payload.html) return extractScrapedContent(payload.html);
      if (payload.page) return extractScrapedContent(payload.page);
      if (payload.pages) return extractScrapedContent(payload.pages);
      if (payload.data) return extractScrapedContent(payload.data);
      if (Array.isArray(payload.results)) {
        const combined = payload.results
          .map((r) => {
            if (typeof r?.text === 'string') return r.text;
            if (typeof r?.content === 'string') return r.content;
            return extractScrapedContent(r);
          })
          .filter(Boolean)
          .join('\n\n');
        if (combined) return combined;
      }
    }

    return '';
  }

  function buildPage(data, index) {
    const fallbackIndex = typeof index === 'number' ? index : pages.length;
    return {
      id: data?.id || generatePageId(),
      title: data?.title || `Page ${fallbackIndex + 1}`,
      url: data?.url || '',
      content: data?.content || '',
      order: typeof data?.order === 'number' ? data.order : fallbackIndex,
    };
  }

  function parsePages(val) {
    if (!val) return [];
    if (Array.isArray(val)) {
      return val.map((item, idx) =>
        buildPage(
          {
            id: item?.id,
            title: item?.title,
            url: item?.url,
            content: item?.content,
            order: typeof item?.order === 'number' ? item.order : idx,
          },
          idx
        )
      );
    }
    if (typeof val === 'object') {
      const arr = Object.entries(val).map(([id, item]) =>
        buildPage({
          id,
          title: item?.title,
          url: item?.url,
          content: item?.content,
          order: typeof item?.order === 'number' ? item.order : 0,
        })
      );
      return arr.sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
    }
    return [];
  }

  function updateDeleteButtonState() {
    if (!deleteBtn) return;
    const disabled = !canWriteFlag || !currentPageId || !pages.length;
    deleteBtn.disabled = disabled;
    deleteBtn.classList.toggle('opacity-60', disabled);
    deleteBtn.classList.toggle('cursor-not-allowed', disabled);
  }

  function updateCounter() {
    const len = (txt.value || '').length;
    counter.textContent = `${len} / ${LIMIT} characters`;
    counter.classList.toggle('text-red-600', len > LIMIT);
    counter.classList.toggle('text-gray-500', len <= LIMIT);
    const disabled = len > LIMIT || !canWriteFlag || !currentPageId;
    btn.disabled = disabled;
    btn.classList.toggle('opacity-60', btn.disabled);
    updateDeleteButtonState();
  }

  function applyTextareaState() {
    const disabled = !currentPageId || !canWriteFlag;
    txt.disabled = disabled;
    txt.classList.toggle('opacity-60', disabled);
    updateCounter();
  }

  function renderTabs() {
    tabsWrap.innerHTML = '';
    pages.forEach((page, idx) => {
      const btnTab = document.createElement('button');
      const isActive = page.id === currentPageId;
      btnTab.dataset.id = page.id;
      btnTab.className = 'page-btn';
      if (isActive) btnTab.classList.add('active');

      btnTab.textContent = page.title || `Page ${idx + 1}`;
      btnTab.addEventListener('click', () => {
        setActivePage(page.id);
      });
      tabsWrap.appendChild(btnTab);
    });
    tabsWrap.classList.toggle('hidden', pages.length === 0);
  }

  function setActivePage(id) {
    currentPageId = id || '';
    const page = pages.find((p) => p.id === currentPageId);
    txt.value = page?.content || '';
    txt.style.height = 'auto';
    txt.style.height = (txt.scrollHeight || 120) + 'px';
    if (page?.url) {
      urlLabel.textContent = page.url;
      urlLabel.setAttribute('title', page.url);
      urlMeta.classList.remove('hidden');
    } else {
      urlLabel.textContent = '';
      urlLabel.removeAttribute('title');
      urlMeta.classList.add('hidden');
    }
    renderTabs();
    applyTextareaState();
    updateDeleteButtonState();
  }

  function ensurePageExists() {
    if (pages.length === 0) {
      const defaultPage = buildPage({ title: 'Page 1', content: '' }, 0);
      pages.push(defaultPage);
    }
  }

  function showSavedMessage() {
    const msg = $('msgContext');
    msg.classList.remove('hidden');
    setTimeout(() => msg.classList.add('hidden'), 1200);
  }

  async function savePages(showToast = false) {
    isSaving = true;
    try {
      pages.forEach((page, idx) => {
        if (!page.title || /^Page\s+\d+$/i.test(page.title)) {
          page.title = `Page ${idx + 1}`;
        }
        page.order = idx;
      });

      const payload = {};
      pages.forEach((page) => {
        payload[page.id] = {
          title: page.title,
          url: page.url || '',
          content: page.content || '',
          order: page.order || 0,
        };
      });

      await pagesRef.set(payload);
      const aggregated = pages.map((p) => p.content || '').filter(Boolean).join('\n\n');
      await legacyRef.set(aggregated);
      if (showToast) showSavedMessage();
    } finally {
      isSaving = false;
    }
  }

  // ✅ SIN OpenAI – obtiene texto completo del crawler
  async function fetchPageContent(url) {
    const endpoint = `https://scraper-json.vercel.app/api/crawl?start=${encodeURIComponent(
      url
    )}&limit=5&raw=1`;
    const res = await fetch(endpoint);
    if (!res.ok) {
      throw new Error('Could not fetch the page content.');
    }
    const text = await res.text();
    const clean = sanitizeText(text);
    return clean.length > 16000 ? clean.slice(0, 16000) : clean;
  }

  // 🚫 función formatWithAI eliminada completamente

  function openModal() {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modalInput.value = '';
    modalError.classList.add('hidden');
    modalStatus.classList.add('hidden');
    setTimeout(() => modalInput.focus(), 50);
  }

  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    modalInput.value = '';
    modalError.classList.add('hidden');
    modalStatus.classList.add('hidden');
  }

  function setModalLoading(loading, message) {
    [modalInput, modalConfirm, modalCancel].forEach((el) => {
      if (el) {
        el.disabled = loading || (!canWriteFlag && el === modalConfirm);
        el.classList.toggle('opacity-60', loading && el === modalConfirm);
      }
    });
    if (loading && message) {
      modalStatus.textContent = message;
      modalStatus.classList.remove('hidden');
    } else {
      modalStatus.classList.add('hidden');
    }
  }

  addBtn?.addEventListener('click', () => {
    if (!canWriteFlag) return;
    openModal();
  });

  modalClose?.addEventListener('click', closeModal);
  modalCancel?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  modalConfirm?.addEventListener(
    'click',
    () =>
      canWrite(async () => {
        const url = (modalInput.value || '').trim();
        if (!url) {
          modalError.textContent = 'Please provide a valid URL.';
          modalError.classList.remove('hidden');
          return;
        }
        modalError.classList.add('hidden');
        try {
          setModalLoading(true, 'Fetching page content...');
          const raw = await fetchPageContent(url);
          // 🧩 Ahora no hay OpenAI: usamos el texto directamente
          const newPage = buildPage(
            {
              title: `Page ${pages.length + 1}`,
              url,
              content: raw,
            },
            pages.length
          );
          pages.push(newPage);
          await savePages(false);
          setActivePage(newPage.id);
          toast('✔ Knowledge page added');
          closeModal();
        } catch (err) {
          console.error(err);
          modalError.textContent =
            err.message || 'Unable to add the page. Please try again.';
          modalError.classList.remove('hidden');
        } finally {
          setModalLoading(false);
        }
      })
  );

  function openDeleteModal(page) {
    if (!deleteModal || !deleteModalTitle) return;
    deleteModalTitle.textContent = page?.title || 'this page';
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
  }

  function closeDeleteModal() {
    if (!deleteModal) return;
    deleteModal.classList.add('hidden');
    deleteModal.classList.remove('flex');
    pageToDeleteId = '';
  }

  deleteBtn?.addEventListener('click', () => {
    if (deleteBtn.disabled) return;
    const page = pages.find((p) => p.id === currentPageId);
    if (!page) return;
    pageToDeleteId = page.id;
    openDeleteModal(page);
  });

  deleteModalClose?.addEventListener('click', closeDeleteModal);
  deleteModalCancel?.addEventListener('click', closeDeleteModal);
  deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) closeDeleteModal();
  });

  deleteModalConfirm?.addEventListener(
    'click',
    () =>
      canWrite(async () => {
        if (!pageToDeleteId) return;
        const index = pages.findIndex((p) => p.id === pageToDeleteId);
        if (index === -1) return;

        const wasActive = currentPageId === pageToDeleteId;
        pages.splice(index, 1);

        if (!pages.length) {
          pages.push(buildPage({ title: 'Page 1', content: '' }, 0));
        }

        let nextId = currentPageId;
        if (wasActive) {
          const fallbackIndex = Math.min(index, pages.length - 1);
          nextId = pages[fallbackIndex]?.id || pages[0]?.id || '';
        }

        if (!pages.some((p) => p.id === nextId)) {
          nextId = pages[0]?.id || '';
        }

        setActivePage(nextId);
        await savePages(false);
        toast('✔ Knowledge page deleted');
        closeDeleteModal();
      })
  );

  txt.addEventListener('input', (e) => {
    const page = pages.find((p) => p.id === currentPageId);
    if (!page) return;
    page.content = e.target.value;
    e.target.style.height = 'auto';
    e.target.style.height = (e.target.scrollHeight || 120) + 'px';
    updateCounter();
  });

  btn.addEventListener('click', () =>
    canWrite(async () => {
      if (btn.disabled) return;
      const page = pages.find((p) => p.id === currentPageId);
      if (page) {
        page.content = txt.value;
      }
      await savePages(true);
    })
  );

  window.__applyKnowledgeWriteState = () => {
    const disabled = !canWriteFlag;
    if (addBtn) {
      addBtn.disabled = disabled;
      addBtn.classList.toggle('opacity-60', disabled);
    }
    updateDeleteButtonState();
    applyTextareaState();
  };

  (async () => {
    const snap = await pagesRef.once('value');
    pages = parsePages(snap.val());

    if (!pages.length) {
      const legacySnap = await legacyRef.once('value');
      const legacyText = legacySnap.val();
      if (legacyText) {
        pages = [buildPage({ title: 'Page 1', content: legacyText }, 0)];
      }
    }

    ensurePageExists();
    renderTabs();
    setActivePage(pages[0]?.id || '');

    pagesRef.on('value', (snap2) => {
      if (isSaving) return;
      const incoming = parsePages(snap2.val());
      if (!incoming.length) {
        pages = [];
        ensurePageExists();
      } else {
        pages = incoming;
      }
      const keepId = pages.some((p) => p.id === currentPageId)
        ? currentPageId
        : pages[0]?.id || '';
      setActivePage(keepId);
    });

    updateCounter();
    if (typeof window.__applyKnowledgeWriteState === 'function') {
      window.__applyKnowledgeWriteState();
    }
  })();
}



function initSchedule() {
  const ref = eref('config/schedule');
  const list = $('scheduleList');
  const btnSave = $('saveSchedule');
  const msg = $('msgSchedule');

  // 🧩 Crear fila de horario
  function makeRow(id, start = "00:00", end = "23:59", days = []) {
    const div = document.createElement('div');
    div.className = "flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border rounded-xl bg-gray-50 p-4 shadow-sm";
    div.dataset.id = id;

    div.innerHTML = `
      <div class="flex items-center gap-2">
        <div class="flex items-center gap-1 border rounded-lg bg-white px-2 py-1">
          <i data-lucide="clock" class="w-4 h-4 text-gray-500"></i>
          <input type="text" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" maxlength="5"
            placeholder="00:00" class="start text-sm border-none outline-none bg-transparent w-16 text-center" value="${start}">
        </div>
        <span class="text-gray-400">→</span>
        <div class="flex items-center gap-1 border rounded-lg bg-white px-2 py-1">
          <i data-lucide="clock" class="w-4 h-4 text-gray-500"></i>
          <input type="text" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" maxlength="5"
            placeholder="23:59" class="end text-sm border-none outline-none bg-transparent w-16 text-center" value="${end}">
        </div>
      </div>

      <div class="flex items-center gap-1 ml-auto">
        ${["S","M","T","W","T","F","S"].map((d,i)=>
          `<button data-day="${i}" class="day w-8 h-8 rounded-full text-xs font-medium transition-all duration-150 ${
            days.includes(i)
              ? 'bg-black text-white shadow-sm'
              : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-100'
          }">${d}</button>`
        ).join('')}
        <button class="delete ml-3 text-gray-400 hover:text-red-600 transition" title="Delete">
          <i data-lucide="trash" class="w-4 h-4"></i>
        </button>
      </div>
    `;

    // 🔸 Validar formato HH:mm (24h)
    div.querySelectorAll('input.start, input.end').forEach(inp => {
      inp.addEventListener('blur', e => {
        let val = e.target.value.trim();
        if (!/^\d{1,2}:\d{2}$/.test(val)) {
          e.target.value = "00:00";
          return;
        }
        let [h, m] = val.split(":").map(Number);
        if (h > 23) h = 23;
        if (m > 59) m = 59;
        e.target.value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      });
    });

    // 🔸 Toggle de días activos
    div.querySelectorAll('.day').forEach(btn => {
      btn.addEventListener('click', () => {
        const active = btn.classList.contains('bg-black');
        if (active) {
          btn.classList.remove('bg-black','text-white','shadow-sm');
          btn.classList.add('bg-white','text-gray-600','border','border-gray-300','hover:bg-gray-100');
        } else {
          btn.classList.add('bg-black','text-white','shadow-sm');
          btn.classList.remove('bg-white','text-gray-600','border','border-gray-300','hover:bg-gray-100');
        }
      });
    });

    // 🗑️ Eliminar fila
    div.querySelector('.delete').onclick = () => {
      div.remove();
      renderActionRow(); // reubica el "+" y "Save"
    };

    lucide.createIcons();
    return div;
  }

  // 🧩 Renderizar botones "+" y "Save" en la misma fila
  function renderActionRow() {
    let actions = document.getElementById('scheduleActions');
    if (actions) actions.remove();

    actions = document.createElement('div');
    actions.id = 'scheduleActions';
    actions.className = "flex justify-end items-center gap-3 mt-4";

    const addBtn = document.createElement('button');
    addBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5"></i>';
    addBtn.className = "bg-black text-white w-9 h-9 rounded-full flex items-center justify-center hover:bg-gray-800 shadow-sm transition";
    addBtn.onclick = () => {
      const newRow = makeRow('r' + Date.now());
      list.appendChild(newRow);
      renderActionRow();
    };

    const saveBtn = document.createElement('button');
    saveBtn.textContent = "Save";
    saveBtn.className = "px-5 py-2 bg-gray-100 rounded-md text-sm hover:bg-gray-200 transition font-medium";
    saveBtn.onclick = saveSchedule;

    actions.appendChild(addBtn);
    actions.appendChild(saveBtn);

    list.insertAdjacentElement('afterend', actions);
    lucide.createIcons();
  }

  // 💾 Guardar configuración
  async function saveSchedule() {
    await canWrite(async () => {
      const rows = list.querySelectorAll('[data-id]');
      const out = {};
      rows.forEach(r => {
        const id = r.dataset.id;
        const start = r.querySelector('.start').value;
        const end = r.querySelector('.end').value;
        const days = [...r.querySelectorAll('.day.bg-black')].map(d => parseInt(d.dataset.day));
        out[id] = { start, end, days };
      });
      await ref.set(out);
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 1200);
    });
  }

  // 🧩 Cargar desde Firebase
  ref.once('value', s => {
    const data = s.val() || {};
    list.innerHTML = '';
    for (const id in data) {
      const r = data[id];
      list.appendChild(makeRow(id, r.start, r.end, r.days || []));
    }
    renderActionRow();
  });
}


// === Function to initialize Integration tab ===
function initIntegration(){
  const code = `<script src="https://tomos.bot/embed.js" data-empresa="${EMPRESA}"><\\/script>`;
  const box = $('embedScriptBox');
  box.value = code;

  // 🔹 Ajuste automático de altura
  box.style.height = 'auto';
  box.style.height = box.scrollHeight + 'px';

  $('copyEmbedScript').onclick = () => {
    navigator.clipboard.writeText(code);
    toast('Copied');
  };
}



// === Function to initialize Auto Responses tab ===
function initRespuestas() {
  if (typeof firebase === "undefined" || typeof eref !== "function") {
    console.warn("⏳ Esperando Firebase...");
    setTimeout(initRespuestas, 400);
    return;
  }

  const tabsEl = $("autoResponseTabs");
  const btnAdd = $("addAutoResponse");
  const btnSave = $("saveAutoResponses");
  const msg = $("msgAutoResponses");
  const editor = $("autoResponseEditor");
  const emptyState = $("autoResponseEmpty");
  const placeholder = $("autoResponsePlaceholder");

  const keywordInput = $("autoResponseKeyword");
  const typeSelector = $("autoResponseType");
  const typeButtons = Array.from(typeSelector?.querySelectorAll(".typeOption") || []);

  const textEditor = $("textEditor");
  const textMessage = $("autoResponseText");
  const textTitle = $("autoResponseTitle");
  const textSubtitle = $("autoResponseSubtitle");
  const textImage = $("autoResponseImage");
  const addTextButton = $("addTextButton");
  const textButtonsList = $("textButtonsList");
  const textPreview = $("textPreview");

  const cardsEditor = $("cardsEditor");
  const cardsList = $("cardsList");
  const addCardButton = $("addCardButton");

  const menuEditor = $("menuEditor");
  const menuIntroText = $("menuIntroText");
  const menuButtonsList = $("menuButtonsList");
  const menuPreview = $("menuPreview");
  const addMenuButton = $("addMenuButton");

  const deleteBtn = $("deleteAutoResponse");

  if (!tabsEl || !btnAdd || !btnSave || !editor || !emptyState) {
    console.warn("⏳ Esperando elementos del DOM...");
    setTimeout(initRespuestas, 400);
    return;
  }

  const ref = eref("config/autoResponses");
  const escapeHtml = (str = "") => String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

  let responses = [];
  let activeIndex = -1;

  const createEmptyResponse = () => ({
    id: "r" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    trigger: "",
    type: "text",
    text: "",
    extras: { title: "", subtitle: "", image: "", buttons: [] },
    cards: [],
    menu: { text: "", buttons: [] }
  });

  function setActive(index) {
    if (index === -1) {
      activeIndex = -1;
    } else if (index < 0 || index >= responses.length) {
      activeIndex = responses.length ? 0 : -1;
    } else {
      activeIndex = index;
    }
    renderTabs();
    renderEditor();
  }

  function deleteResponse(index) {
    if (index < 0 || index >= responses.length) return;
    responses.splice(index, 1);
    setActive(activeIndex >= responses.length ? responses.length - 1 : activeIndex);
  }

  function renderTabs() {
    tabsEl.innerHTML = "";
    const typeStyles = {
      text: "bg-blue-100 text-blue-700",
      cards: "bg-purple-100 text-purple-700",
      menu: "bg-emerald-100 text-emerald-700"
    };

    responses.forEach((item, idx) => {
      const tab = document.createElement("button");
      tab.type = "button";
      const isActive = idx === activeIndex;
      tab.className = `relative flex min-w-[160px] flex-col gap-1 rounded-2xl border px-3 py-2 text-left transition ${isActive ? "bg-black text-white border-black shadow-sm" : "bg-white border-gray-200 text-gray-700 hover:border-black/40"}`;

      const topRow = document.createElement("div");
      topRow.className = "flex items-center gap-2";
      const number = document.createElement("span");
      number.className = `flex h-6 w-6 items-center justify-center rounded-full text-[11px] font-semibold ${isActive ? "bg-white text-black" : "bg-black/10 text-gray-700"}`;
      number.textContent = idx + 1;
      const badge = document.createElement("span");
      badge.className = `px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide rounded-full ${typeStyles[item.type] || "bg-gray-100 text-gray-600"}`;
      badge.textContent = (item.type || "text").toUpperCase();
      topRow.append(number, badge);

      const label = document.createElement("div");
      label.className = `text-xs font-medium truncate ${isActive ? "text-white/90" : "text-gray-700"}`;
      label.textContent = item.trigger || "Keyword";

      tab.append(topRow, label);
      tab.addEventListener("click", () => setActive(idx));

      const remove = document.createElement("button");
      remove.type = "button";
      remove.className = "absolute -top-1.5 -right-1.5 bg-white border border-gray-200 rounded-full w-5 h-5 flex items-center justify-center text-[10px] text-gray-500 hover:text-red-600 hover:border-red-300";
      remove.innerHTML = "&times;";
      remove.addEventListener("click", e => {
        e.stopPropagation();
        deleteResponse(idx);
      });

      tab.appendChild(remove);
      tabsEl.appendChild(tab);
    });
  }

  function renderEditor() {
    if (!responses.length) {
      editor.classList.add("hidden");
      emptyState.classList.remove("hidden");
      if (placeholder) placeholder.classList.add("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    if (activeIndex < 0) {
      editor.classList.add("hidden");
      if (placeholder) placeholder.classList.remove("hidden");
      return;
    }

    if (placeholder) placeholder.classList.add("hidden");

    const item = responses[activeIndex];
    editor.classList.remove("hidden");

    keywordInput.value = item.trigger || "";

    typeButtons.forEach(btn => {
      const isActive = btn.dataset.type === item.type;
      btn.classList.toggle("bg-white", isActive);
      btn.classList.toggle("text-black", isActive);
      btn.classList.toggle("shadow-sm", isActive);
      btn.classList.toggle("bg-gray-100", !isActive);
      btn.classList.toggle("text-gray-500", !isActive);
    });

    textEditor.classList.toggle("hidden", item.type !== "text");
    cardsEditor.classList.toggle("hidden", item.type !== "cards");
    menuEditor.classList.toggle("hidden", item.type !== "menu");

    if (item.type === "text") {
      textMessage.value = item.text || "";
      textTitle.value = item.extras?.title || "";
      textSubtitle.value = item.extras?.subtitle || "";
      textImage.value = item.extras?.image || "";
      if (!Array.isArray(item.extras.buttons)) item.extras.buttons = [];
      renderTextButtons(item);
      renderTextPreview(item);
    }

    if (item.type === "cards") {
      if (!Array.isArray(item.cards)) item.cards = [];
      renderCards(item);
    }

    if (item.type === "menu") {
      if (!item.menu) item.menu = { text: "", buttons: [] };
      if (!Array.isArray(item.menu.buttons)) item.menu.buttons = [];
      menuIntroText.value = item.menu.text || "";
      renderMenuButtons(item);
      updateMenuPreview(item);
    }
  }

  function renderTextButtons(item) {
    const buttons = item.extras.buttons || (item.extras.buttons = []);
    textButtonsList.innerHTML = "";
    if (!buttons.length) {
      const empty = document.createElement("p");
      empty.className = "text-xs text-gray-400";
      empty.textContent = "No buttons added yet.";
      textButtonsList.appendChild(empty);
      return;
    }

    buttons.forEach((btn, idx) => {
      const row = document.createElement("div");
      row.className = "flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-gray-50 border border-gray-200 rounded-xl px-3 py-2";

      const labelInput = document.createElement("input");
      labelInput.type = "text";
      labelInput.className = "flex-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
      labelInput.placeholder = "Button text";
      labelInput.value = btn.label || "";
      labelInput.addEventListener("input", e => {
        btn.label = e.target.value;
        renderTextPreview(item);
      });

      const linkInput = document.createElement("input");
      linkInput.type = "text";
      linkInput.className = "flex-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
      linkInput.placeholder = "Link or trigger";
      linkInput.value = btn.link || "";
      linkInput.addEventListener("input", e => {
        btn.link = e.target.value;
      });

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "text-xs text-red-600 hover:text-red-700";
      removeBtn.textContent = "Delete";
      removeBtn.addEventListener("click", () => {
        buttons.splice(idx, 1);
        renderTextButtons(item);
        renderTextPreview(item);
      });

      row.append(labelInput, linkInput, removeBtn);
      textButtonsList.appendChild(row);
    });
  }

  function renderTextPreview(item) {
    const body = item.text || "";
    const { title = "", subtitle = "", image = "", buttons = [] } = item.extras || {};
    const actions = (buttons || []).filter(b => (b.label || "").trim());

    if (!image && !title && !subtitle && !body && !actions.length) {
      textPreview.innerHTML = `<p class="text-xs text-gray-400 text-center w-full">Start writing to see the live preview.</p>`;
      return;
    }

    const buttonsHtml = actions.map(b => `<span class="inline-flex items-center justify-center border border-black rounded-full px-3 py-1 text-xs text-black">${escapeHtml(b.label)}</span>`).join(" ");

    textPreview.innerHTML = `
      <div class="inline-block bg-white rounded-2xl shadow-sm border border-gray-200 w-72 text-left text-gray-800 overflow-hidden">
        ${image ? `<img src="${escapeHtml(image)}" class="w-full h-36 object-cover" alt="Preview image">` : ""}
        <div class="p-3 space-y-2">
          ${title ? `<h3 class="font-semibold text-base">${escapeHtml(title)}</h3>` : ""}
          ${subtitle ? `<p class="text-sm text-gray-500">${escapeHtml(subtitle)}</p>` : ""}
          ${body ? `<p class="text-sm text-gray-700">${escapeHtml(body)}</p>` : ""}
          ${actions.length ? `<div class="flex flex-wrap gap-2 pt-2">${buttonsHtml}</div>` : ""}
        </div>
      </div>
    `;
  }

  function renderCards(item) {
    cardsList.innerHTML = "";
    const cards = item.cards || (item.cards = []);

    if (!cards.length) {
      const empty = document.createElement("p");
      empty.className = "text-xs text-gray-400";
      empty.textContent = "No cards yet. Add one to build a carousel.";
      cardsList.appendChild(empty);
      return;
    }

    if (typeof item.__activeCardIndex !== "number" || item.__activeCardIndex < 0) {
      item.__activeCardIndex = 0;
    }
    if (item.__activeCardIndex >= cards.length) {
      item.__activeCardIndex = cards.length - 1;
    }

    const tabsWrap = document.createElement("div");
    tabsWrap.className = "flex items-center gap-2 overflow-x-auto pb-2 flex-nowrap";

    cards.forEach((card, idx) => {
      const tabBtn = document.createElement("button");
      tabBtn.type = "button";
      const isActive = idx === item.__activeCardIndex;
      tabBtn.className = `whitespace-nowrap rounded-full border px-3 py-1.5 text-xs font-medium transition ${isActive ? "bg-black text-white border-black" : "bg-white border-gray-200 text-gray-600 hover:border-black/40"}`;
      tabBtn.textContent = `Card ${idx + 1}`;
      tabBtn.addEventListener("click", () => {
        item.__activeCardIndex = idx;
        renderCards(item);
      });
      tabsWrap.appendChild(tabBtn);
    });

    cardsList.appendChild(tabsWrap);

    const activeCard = cards[item.__activeCardIndex];

    const wrap = document.createElement("div");
    wrap.className = "border border-gray-200 rounded-2xl bg-white p-4 shadow-sm space-y-4";

    const header = document.createElement("div");
    header.className = "flex items-center justify-between";
    const title = document.createElement("span");
    title.className = "text-sm font-semibold text-gray-700";
    title.textContent = `Card ${item.__activeCardIndex + 1}`;
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "text-xs text-red-600 hover:text-red-700";
    removeBtn.textContent = "Delete";
    removeBtn.addEventListener("click", () => {
      cards.splice(item.__activeCardIndex, 1);
      if (!cards.length) {
        delete item.__activeCardIndex;
      } else if (item.__activeCardIndex >= cards.length) {
        item.__activeCardIndex = cards.length - 1;
      }
      renderCards(item);
    });
    header.append(title, removeBtn);
    wrap.appendChild(header);

    const grid = document.createElement("div");
    grid.className = "grid gap-3 sm:grid-cols-2";

    const titleWrap = document.createElement("div");
    titleWrap.className = "space-y-1";
    const titleLabel = document.createElement("label");
    titleLabel.className = "block text-xs font-semibold text-gray-600";
    titleLabel.textContent = "Title";
    const titleInput = document.createElement("input");
    titleInput.type = "text";
    titleInput.className = "w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
    titleInput.placeholder = "Title";
    titleInput.value = activeCard.title || "";
    titleInput.addEventListener("input", e => {
      activeCard.title = e.target.value;
      updateCardPreview();
    });
    titleWrap.append(titleLabel, titleInput);

    const subtitleWrap = document.createElement("div");
    subtitleWrap.className = "space-y-1";
    const subtitleLabel = document.createElement("label");
    subtitleLabel.className = "block text-xs font-semibold text-gray-600";
    subtitleLabel.textContent = "Subtitle";
    const subtitleInput = document.createElement("input");
    subtitleInput.type = "text";
    subtitleInput.className = "w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
    subtitleInput.placeholder = "Subtitle";
    subtitleInput.value = activeCard.subtitle || "";
    subtitleInput.addEventListener("input", e => {
      activeCard.subtitle = e.target.value;
      updateCardPreview();
    });
    subtitleWrap.append(subtitleLabel, subtitleInput);

    grid.append(titleWrap, subtitleWrap);
    wrap.appendChild(grid);

    const imageWrap = document.createElement("div");
    imageWrap.className = "space-y-1";
    const imageLabel = document.createElement("label");
    imageLabel.className = "block text-xs font-semibold text-gray-600";
    imageLabel.textContent = "Image URL";
    const imageInput = document.createElement("input");
    imageInput.type = "text";
    imageInput.className = "w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
    imageInput.placeholder = "https://...";
    imageInput.value = activeCard.image || "";
    imageInput.addEventListener("input", e => {
      activeCard.image = e.target.value;
      updateCardPreview();
    });
    imageWrap.append(imageLabel, imageInput);
    wrap.appendChild(imageWrap);

    const linkWrap = document.createElement("div");
    linkWrap.className = "space-y-1";
    const linkLabel = document.createElement("label");
    linkLabel.className = "block text-xs font-semibold text-gray-600";
    linkLabel.textContent = "Link";
    const linkInput = document.createElement("input");
    linkInput.type = "text";
    linkInput.className = "w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
    linkInput.placeholder = "https://...";
    linkInput.value = activeCard.link || "";
    linkInput.addEventListener("input", e => {
      activeCard.link = e.target.value;
    });
    linkWrap.append(linkLabel, linkInput);
    wrap.appendChild(linkWrap);

    const buttonWrap = document.createElement("div");
    buttonWrap.className = "space-y-1";
    const buttonLabel = document.createElement("label");
    buttonLabel.className = "block text-xs font-semibold text-gray-600";
    buttonLabel.textContent = "Button text";
    const buttonTextInput = document.createElement("input");
    buttonTextInput.type = "text";
    buttonTextInput.className = "w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
    buttonTextInput.placeholder = "Reserve now";
    buttonTextInput.value = activeCard.buttonText || "View";
    buttonTextInput.addEventListener("input", e => {
      activeCard.buttonText = e.target.value;
      updateCardPreview();
    });
    buttonWrap.append(buttonLabel, buttonTextInput);
    wrap.appendChild(buttonWrap);

    const preview = document.createElement("div");
    preview.className = "bg-gray-50 border border-gray-200 rounded-xl p-3";

    function updateCardPreview() {
      preview.innerHTML = `
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          ${activeCard.image ? `<img src="${escapeHtml(activeCard.image)}" class="w-full h-32 object-cover" alt="">` : ""}
          <div class="p-3 space-y-2">
            ${activeCard.title ? `<h4 class="text-sm font-semibold text-gray-800">${escapeHtml(activeCard.title)}</h4>` : ""}
            ${activeCard.subtitle ? `<p class="text-xs text-gray-500">${escapeHtml(activeCard.subtitle)}</p>` : ""}
            ${(activeCard.buttonText || "").trim() ? `<div class="pt-1"><span class="inline-flex text-xs border border-black rounded-full px-3 py-1">${escapeHtml(activeCard.buttonText)}</span></div>` : ""}
          </div>
        </div>
      `;
    }

    updateCardPreview();
    wrap.appendChild(preview);

    cardsList.appendChild(wrap);
  }

  function renderMenuButtons(item) {
    const buttons = item.menu.buttons || (item.menu.buttons = []);
    menuButtonsList.innerHTML = "";
    if (!buttons.length) {
      const empty = document.createElement("p");
      empty.className = "text-xs text-gray-400";
      empty.textContent = "Add options so guests can tap them quickly.";
      menuButtonsList.appendChild(empty);
      return;
    }

    buttons.forEach((btn, idx) => {
      btn.action = btn.action || btn.link || btn.trigger || "";
      const row = document.createElement("div");
      row.className = "flex flex-col sm:flex-row gap-2 items-start sm:items-center bg-white border border-gray-200 rounded-xl px-3 py-2 shadow-sm";

      const labelInput = document.createElement("input");
      labelInput.type = "text";
      labelInput.className = "flex-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
      labelInput.placeholder = "Button label";
      labelInput.value = btn.label || "";
      labelInput.addEventListener("input", e => {
        btn.label = e.target.value;
        updateMenuPreview(item);
      });

      const actionInput = document.createElement("input");
      actionInput.type = "text";
      actionInput.className = "flex-1 w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/60";
      actionInput.placeholder = "Trigger or link";
      actionInput.value = btn.action;
      actionInput.addEventListener("input", e => {
        btn.action = e.target.value;
        updateMenuPreview(item);
      });

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "text-xs text-red-600 hover:text-red-700";
      removeBtn.textContent = "Delete";
      removeBtn.addEventListener("click", () => {
        buttons.splice(idx, 1);
        renderMenuButtons(item);
        updateMenuPreview(item);
      });

      row.append(labelInput, actionInput, removeBtn);
      menuButtonsList.appendChild(row);
    });
  }

  function updateMenuPreview(item) {
    menuPreview.innerHTML = "";
    const intro = item.menu.text || "";
    if (intro) {
      const introEl = document.createElement("p");
      introEl.className = "w-full text-sm text-gray-600";
      introEl.textContent = intro;
      menuPreview.appendChild(introEl);
    }

    const wrap = document.createElement("div");
    wrap.className = `flex flex-wrap gap-2${intro ? " mt-3" : ""}`;
    (item.menu.buttons || []).forEach(btn => {
      if (!(btn.label || "").trim()) return;
      const pill = document.createElement("span");
      pill.className = "inline-flex items-center border border-black rounded-full px-3 py-1 text-xs text-black";
      pill.textContent = btn.label;
      wrap.appendChild(pill);
    });

    if (!wrap.childElementCount) {
      const placeholder = document.createElement("p");
      placeholder.className = "text-xs text-gray-400";
      placeholder.textContent = "Menu buttons will appear here.";
      menuPreview.appendChild(placeholder);
    } else {
      menuPreview.appendChild(wrap);
    }
  }

  btnAdd.addEventListener("click", () => {
    responses.push(createEmptyResponse());
    setActive(responses.length - 1);
  });

  btnSave.addEventListener("click", async () => {
    const saveData = {};
    responses.forEach(res => {
      const trigger = (res.trigger || "").trim();
      if (!trigger) return;

      const out = {
        trigger,
        type: res.type || "text",
        text: res.type === "menu" ? (res.menu?.text || "") : (res.type === "text" ? (res.text || "") : (res.text || "")),
        cards: [],
        extras: {}
      };

      if (res.type === "text") {
        out.text = res.text || "";
        out.extras = {
          title: res.extras?.title || "",
          subtitle: res.extras?.subtitle || "",
          image: res.extras?.image || "",
          buttons: (res.extras?.buttons || [])
            .map(b => ({
              label: (b.label || "").trim(),
              link: (b.link || "").trim()
            }))
            .filter(b => b.label || b.link)
        };
      }

      if (res.type === "cards") {
        out.cards = (res.cards || [])
          .map(c => ({
            title: c.title || "",
            subtitle: c.subtitle || "",
            image: c.image || "",
            link: c.link || "",
            buttonText: c.buttonText || "View"
          }))
          .filter(c => (c.title || c.subtitle || c.image || c.link));
        out.extras = {};
      }

      if (res.type === "menu") {
        out.text = res.menu?.text || "";
        out.extras = {
          buttons: (res.menu?.buttons || [])
            .map(btn => {
              const label = (btn.label || "").trim();
              const action = (btn.action || btn.link || btn.trigger || "").trim();
              if (!label || !action) return null;
              return action.startsWith("http")
                ? { label, link: action }
                : { label, trigger: action };
            })
            .filter(Boolean)
        };
      }

      saveData[res.id] = out;
    });

    await ref.set(saveData);
    msg.classList.remove("hidden");
    setTimeout(() => msg.classList.add("hidden"), 1500);
  });

  keywordInput.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].trigger = e.target.value;
    renderTabs();
  });

  textMessage.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].text = e.target.value;
    renderTextPreview(responses[activeIndex]);
  });

  textTitle.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].extras.title = e.target.value;
    renderTextPreview(responses[activeIndex]);
  });

  textSubtitle.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].extras.subtitle = e.target.value;
    renderTextPreview(responses[activeIndex]);
  });

  textImage.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].extras.image = e.target.value;
    renderTextPreview(responses[activeIndex]);
  });

  addTextButton.addEventListener("click", () => {
    if (!responses.length || activeIndex < 0) return;
    const item = responses[activeIndex];
    if (!Array.isArray(item.extras.buttons)) item.extras.buttons = [];
    item.extras.buttons.push({ label: "", link: "" });
    renderTextButtons(item);
    renderTextPreview(item);
  });

  addCardButton.addEventListener("click", () => {
    if (!responses.length || activeIndex < 0) return;
    const item = responses[activeIndex];
    if (!Array.isArray(item.cards)) item.cards = [];
    item.cards.push({ title: "", subtitle: "", image: "", link: "", buttonText: "View" });
    item.__activeCardIndex = item.cards.length - 1;
    renderCards(item);
  });

  menuIntroText.addEventListener("input", e => {
    if (!responses.length || activeIndex < 0) return;
    responses[activeIndex].menu.text = e.target.value;
    updateMenuPreview(responses[activeIndex]);
  });

  addMenuButton.addEventListener("click", () => {
    if (!responses.length || activeIndex < 0) return;
    const item = responses[activeIndex];
    if (!Array.isArray(item.menu.buttons)) item.menu.buttons = [];
    item.menu.buttons.push({ label: "", action: "" });
    renderMenuButtons(item);
    updateMenuPreview(item);
  });

  deleteBtn.addEventListener("click", () => {
    if (!responses.length || activeIndex < 0) return;
    deleteResponse(activeIndex);
  });

  typeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      if (!responses.length || activeIndex < 0) return;
      const item = responses[activeIndex];
      item.type = btn.dataset.type;
      if (item.type === "cards" && (!Array.isArray(item.cards) || !item.cards.length)) {
        item.cards = [{ title: "", subtitle: "", image: "", link: "", buttonText: "View" }];
        item.__activeCardIndex = 0;
      }
      if (item.type === "menu") {
        if (!item.menu) item.menu = { text: "", buttons: [] };
        if (!Array.isArray(item.menu.buttons) || !item.menu.buttons.length) {
          item.menu.buttons = [{ label: "", action: "" }];
        }
      }
      if (item.type !== "cards") {
        delete item.__activeCardIndex;
      }
      renderTabs();
      renderEditor();
    });
  });

  ref.once("value").then(snap => {
    const data = snap.val() || {};
    responses = Object.entries(data).map(([id, val]) => ({
      id,
      trigger: val.trigger || "",
      type: val.type || "text",
      text: val.text || "",
      extras: {
        title: val.extras?.title || "",
        subtitle: val.extras?.subtitle || "",
        image: val.extras?.image || "",
        buttons: Array.isArray(val.extras?.buttons) && val.type === "text"
          ? val.extras.buttons.map(b => ({ label: b.label || "", link: b.link || "" }))
          : []
      },
      cards: Array.isArray(val.cards) ? val.cards.map(c => ({
        title: c.title || "",
        subtitle: c.subtitle || "",
        image: c.image || "",
        link: c.link || "",
        buttonText: c.buttonText || "View"
      })) : [],
      menu: {
        text: val.type === "menu" ? (val.text || "") : "",
        buttons: Array.isArray(val.extras?.buttons) && val.type === "menu"
          ? val.extras.buttons.map(b => ({
              label: b.label || "",
              action: (b.link || b.trigger || "")
            }))
          : []
      }
    }));

    setActive(-1);
  });
}




// === Function: Welcome Message ===
function initWelcome() {
  const ref = eref("config/chatWelcome");
  const enabled = $("welcomeEnabled");
  const text = $("welcomeText");
  const delay = $("welcomeDelay");
  const file = $("welcomeImageFile");
  const preview = $("welcomePreview");
  const saveBtn = $("saveWelcome");
  const msg = $("msgWelcome");

  if (!ref) return console.warn("❌ No se encontró la referencia de chatWelcome");

  // Cargar desde Firebase
  ref.once("value", snap => {
    const val = snap.val() || {};
    enabled.checked = !!val.enabled;
    text.value = val.text || "";
    delay.value = val.delay || 2;
    if (val.image) {
      preview.src = val.image;
      preview.classList.remove("hidden");
    }
  });

  // Mostrar preview al elegir imagen
  file.addEventListener("change", e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      preview.src = ev.target.result;
      preview.classList.remove("hidden");
    };
    reader.readAsDataURL(f);
  });

  // Guardar en Firebase
  saveBtn.onclick = async () => canWrite(async () => {
    let imageUrl = preview.src || "";
    // Si el usuario cargó un nuevo archivo, subir a Storage
    if (file.files.length) {
      const storageRef = firebase.storage().ref(`${EMPRESA}/welcome.jpg`);
      await storageRef.put(file.files[0]);
      imageUrl = await storageRef.getDownloadURL();
    }

    await ref.set({
      enabled: enabled.checked,
      text: text.value.trim(),
      delay: parseInt(delay.value) || 0,
      image: imageUrl
    });

    msg.classList.remove("hidden");
    setTimeout(() => msg.classList.add("hidden"), 1500);
  });
}




// First paint
window.addEventListener('load', ()=>{ $('pageLoader').style.display='none'; });
</script>

<!-- 🎯 Selector de icono del widget -->
<div id="widgetIconModal"
  class="fixed inset-0 z-[9998] hidden items-center justify-center bg-black/60 px-4 backdrop-blur-sm">
  <div class="card w-full max-w-md space-y-5">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-zinc-900">Choose the widget icon</h3>
      <button type="button" id="closeWidgetIconModal" class="rounded-full p-2 text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-700">
        <i data-lucide="x" class="h-4 w-4"></i>
      </button>
    </div>
    <p class="text-sm text-zinc-500">Select one of the available icons for your widget.</p>
    <div class="grid grid-cols-3 gap-4">
      <button type="button" class="widget-icon-option" data-widget-icon="widgets/1.png">
        <img src="widgets/1.png" alt="Icon 1" />
      </button>
      <button type="button" class="widget-icon-option" data-widget-icon="widgets/2.png">
        <img src="widgets/2.png" alt="Icon 2" />
      </button>
      <button type="button" class="widget-icon-option" data-widget-icon="widgets/3.png">
        <img src="widgets/3.png" alt="Icon 3" />
      </button>
    </div>
  </div>
</div>


<!-- 🧑‍🎨 Avatar Crop Modal -->
<div id="cropperModalAvatar"
  class="fixed inset-0 z-[9998] hidden items-center justify-center bg-black/60 px-4 backdrop-blur-sm">
  <div class="card w-full max-w-sm space-y-5 text-center">
    <h3 class="text-lg font-semibold text-zinc-900">Crop Avatar</h3>
    <div class="flex aspect-square w-full items-center justify-center overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-50">
      <img id="cropperImageAvatar" class="max-w-full max-h-[300px]" />
    </div>

    <!-- Progress -->
    <div id="avatarProgressWrap" class="hidden w-full overflow-hidden rounded-full bg-zinc-200">
      <div id="avatarBar" class="h-2 w-0 bg-zinc-900 transition-all duration-200"></div>
    </div>

    <div class="flex justify-center gap-3">
      <button id="cancelCropAvatar" class="rounded-full border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 transition hover:border-zinc-300 hover:bg-zinc-100">Cancel</button>
      <button id="confirmCropAvatar" class="rounded-full bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-zinc-800">Save</button>
    </div>
  </div>
</div>


</body>
</html>
